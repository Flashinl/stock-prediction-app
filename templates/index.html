<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockTrek - AI Stock Analysis Platform</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Smooth animations and transitions */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }

        .animate-fade-in {
            animation: fadeInUp 0.6s ease-out;
        }

        .animate-slide-in {
            animation: slideInLeft 0.6s ease-out;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%);
            min-height: 100vh;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: #00ff88;
        }

        .header h1 {
            font-size: 3.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.3rem;
            color: #888;
            margin-bottom: 20px;
        }

        .auth-section {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .auth-btn {
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid #00ff88;
            color: #00ff88;
            padding: 10px 20px;
            margin-left: 10px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .auth-btn:hover {
            background: #00ff88;
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .main-card {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 255, 136, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .input-section {
            padding: 40px;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05) 0%, rgba(0, 0, 0, 0.3) 100%);
            border-bottom: 1px solid rgba(0, 255, 136, 0.1);
        }

        .input-group {
            display: flex;
            gap: 15px;
            max-width: 800px;
            margin: 0 auto;
            align-items: flex-end;
        }

        .timeframe-selector {
            min-width: 200px;
        }

        .timeframe-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .timeframe-select:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .timeframe-select option {
            background: #1a1a1a;
            color: #fff;
            padding: 10px;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .stock-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-top: none;
            border-radius: 0 0 15px 15px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .stock-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 255, 136, 0.1);
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stock-dropdown-item:hover {
            background: rgba(0, 255, 136, 0.1);
        }

        .stock-dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-symbol {
            color: #00ff88;
            font-weight: 700;
            font-size: 1rem;
        }

        .dropdown-name {
            color: #ccc;
            font-size: 0.9rem;
            margin-left: 10px;
            flex: 1;
            text-align: left;
        }

        .dropdown-sector {
            color: #888;
            font-size: 0.8rem;
        }

        .stock-input {
            width: 100%;
            padding: 18px 25px;
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px;
            font-size: 1.2rem;
            text-transform: uppercase;
            transition: all 0.3s ease;
            background: rgba(0, 0, 0, 0.7);
            color: #00ff88;
            font-weight: 600;
            letter-spacing: 2px;
        }

        .stock-input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            background: rgba(0, 0, 0, 0.9);
        }

        .stock-input::placeholder {
            color: rgba(0, 255, 136, 0.5);
            font-weight: 400;
            letter-spacing: 1px;
        }

        .predict-btn {
            padding: 18px 35px;
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .predict-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 255, 136, 0.4);
            background: linear-gradient(135deg, #00cc6a 0%, #00ff88 100%);
        }

        .predict-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            color: #00ff88;
        }

        .spinner {
            border: 4px solid rgba(0, 255, 136, 0.1);
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .results {
            display: none;
            padding: 40px;
        }

        .stock-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 0, 0, 0.3) 100%);
            border-radius: 15px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .company-name {
            font-size: 2.5rem;
            color: #00ff88;
            margin-bottom: 8px;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .stock-symbol {
            font-size: 1.4rem;
            color: #888;
            font-weight: 600;
            letter-spacing: 3px;
        }

        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: rgba(0, 0, 0, 0.6);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid rgba(0, 255, 136, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #00ff88, #00cc6a);
        }

        .metric-card:hover {
            border-color: #00ff88;
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
            transform: translateY(-5px);
        }

        .metric-label {
            font-size: 1rem;
            color: #888;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }

        .metric-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: #e0e0e0;
        }

        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        .neutral { color: #ffaa00; }

        .prediction-badge {
            display: inline-block;
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 1.1rem;
        }

        .buy { background: rgba(0, 255, 136, 0.2); color: #00ff88; border: 2px solid #00ff88; }
        .sell { background: rgba(255, 68, 68, 0.2); color: #ff4444; border: 2px solid #ff4444; }
        .hold { background: rgba(255, 170, 0, 0.2); color: #ffaa00; border: 2px solid #ffaa00; }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 40px 0;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(0, 255, 136, 0.2);
            border-radius: 20px;
            padding: 25px;
            position: relative;
        }

        .chart-title {
            color: #00ff88;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .technical-indicators {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(0, 255, 136, 0.2);
            padding: 30px;
            border-radius: 20px;
            margin-top: 30px;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .indicator {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0, 255, 136, 0.1);
            color: #e0e0e0;
        }

        .indicator:last-child {
            border-bottom: none;
        }

        .indicator-label {
            color: #888;
            font-weight: 600;
        }

        .indicator-value {
            color: #00ff88;
            font-weight: 700;
        }

        .error {
            background: rgba(255, 68, 68, 0.1);
            color: #ff4444;
            border: 2px solid rgba(255, 68, 68, 0.3);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .disclaimer {
            background: rgba(255, 170, 0, 0.1);
            color: #ffaa00;
            border: 2px solid rgba(255, 170, 0, 0.3);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-top: 40px;
            font-size: 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(20, 20, 20, 0.95);
            margin: 10% auto;
            padding: 40px;
            border: 2px solid #00ff88;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            color: #e0e0e0;
        }

        .modal h2 {
            color: #00ff88;
            margin-bottom: 25px;
            text-align: center;
            font-size: 2rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #888;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #e0e0e0;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .close {
            color: #888;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            margin-top: -10px;
        }

        .close:hover {
            color: #00ff88;
        }

        /* Landing Page Styles */
        .hero-section {
            text-align: center;
            padding: 80px 0;
            background: rgba(0, 255, 136, 0.05);
            border-radius: 20px;
            margin-bottom: 60px;
            border: 1px solid rgba(0, 255, 136, 0.1);
        }

        .hero-content h2 {
            font-size: 3rem;
            color: #00ff88;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .hero-description {
            font-size: 1.3rem;
            color: #ccc;
            max-width: 800px;
            margin: 0 auto 40px;
            line-height: 1.6;
        }

        .cta-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .cta-btn {
            padding: 18px 35px;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 200px;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .cta-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.2) 50%, transparent 100%);
            transition: left 0.6s ease;
        }

        .cta-btn:hover::before {
            left: 100%;
        }

        .cta-btn.primary {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        .cta-btn.secondary {
            background: transparent;
            color: #00ff88;
            border: 2px solid #00ff88;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.2);
        }

        .cta-btn:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0, 255, 136, 0.4);
        }

        .cta-btn.primary:hover {
            box-shadow: 0 20px 40px rgba(0, 255, 136, 0.5);
        }

        .cta-btn:active {
            transform: translateY(-2px) scale(1.02);
            transition: all 0.1s ease;
        }

        .section-title {
            text-align: center;
            font-size: 2.5rem;
            color: #00ff88;
            margin-bottom: 50px;
            text-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }

        .features-section {
            margin-bottom: 80px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 50px;
        }

        .feature-card {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(0, 255, 136, 0.2);
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            border-color: #00ff88;
            box-shadow: 0 15px 40px rgba(0, 255, 136, 0.2);
            transform: translateY(-10px);
        }

        .feature-icon {
            font-size: 3rem;
            color: #00ff88;
            margin-bottom: 20px;
        }

        .feature-card h3 {
            font-size: 1.5rem;
            color: #e0e0e0;
            margin-bottom: 15px;
        }

        .feature-card p {
            color: #aaa;
            line-height: 1.6;
        }

        .pricing-section {
            margin-bottom: 60px;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin-top: 50px;
        }

        .pricing-card {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(0, 255, 136, 0.2);
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .pricing-card.featured {
            border-color: #00ff88;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
            transform: scale(1.05);
        }

        .popular-badge {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: #00ff88;
            color: #000;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .pricing-card h3 {
            font-size: 1.8rem;
            color: #e0e0e0;
            margin-bottom: 20px;
        }

        .price {
            font-size: 3rem;
            color: #00ff88;
            font-weight: 800;
            margin-bottom: 30px;
        }

        .price span {
            font-size: 1.2rem;
            color: #888;
        }

        .features-list {
            list-style: none;
            margin-bottom: 30px;
        }

        .features-list li {
            color: #ccc;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .features-list i {
            color: #00ff88;
        }

        .pricing-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pricing-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 255, 136, 0.3);
        }

        /* Sidebar Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(145deg, #0a0a0a 0%, #1a1a1a 50%, #0f1419 100%) !important;
            border-right: 2px solid #00ff88 !important;
            padding: 0;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            height: 100vh !important;
            overflow-y: auto;
            z-index: 9999 !important;
            backdrop-filter: blur(15px);
            box-shadow: 4px 0 25px rgba(0, 255, 136, 0.15), inset -1px 0 0 rgba(0, 255, 136, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            padding: 25px 20px 25px 20px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.3);
            margin-bottom: 0;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05) 0%, rgba(0, 255, 136, 0.02) 100%);
            position: relative;
        }

        .sidebar-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20px;
            right: 20px;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, #00ff88 50%, transparent 100%);
        }

        .sidebar-header h2 {
            color: #00ff88;
            font-size: 1.6rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .sidebar-header h2 i {
            font-size: 1.4rem;
            filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.5));
        }

        .sidebar-nav {
            padding: 20px 15px;
        }

        .nav-item {
            background: transparent;
            color: #999;
            border: none;
            padding: 16px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 14px;
            width: 100%;
            margin-bottom: 6px;
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(0, 255, 136, 0.1) 50%, transparent 100%);
            transition: left 0.5s ease;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.15) 0%, rgba(0, 255, 136, 0.05) 100%);
            color: #00ff88;
            transform: translateX(8px);
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.1);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.25) 0%, rgba(0, 255, 136, 0.1) 100%);
            color: #00ff88;
            border-left: 4px solid #00ff88;
            box-shadow: 0 6px 25px rgba(0, 255, 136, 0.2);
            transform: translateX(4px);
        }

        .nav-item.active::before {
            display: none;
        }

        .nav-item i {
            width: 22px;
            text-align: center;
            transition: all 0.3s ease;
            filter: drop-shadow(0 0 4px rgba(0, 255, 136, 0.3));
        }

        .nav-item:hover i,
        .nav-item.active i {
            transform: scale(1.1);
            filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.6));
        }

        .main-content {
            margin-left: 280px !important;
            flex: 1;
            padding: 20px;
            min-height: 100vh;
            width: calc(100% - 280px) !important;
            background: transparent;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Hide any old tab navigation */
        .tab-navigation {
            display: none !important;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Dashboard Styles */
        .dashboard-hero {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: rgba(0, 255, 136, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(0, 255, 136, 0.1);
        }

        .dashboard-hero h2 {
            font-size: 2.5rem;
            color: #00ff88;
            margin-bottom: 10px;
        }

        .dashboard-hero p {
            color: #ccc;
            font-size: 1.2rem;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(10, 10, 10, 0.6) 100%);
            border: 2px solid rgba(0, 255, 136, 0.2);
            border-radius: 20px;
            padding: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(0, 255, 136, 0.1) 50%, transparent 100%);
            transition: left 0.6s ease;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            border-color: #00ff88;
            box-shadow: 0 15px 40px rgba(0, 255, 136, 0.25), 0 5px 15px rgba(0, 255, 136, 0.1);
            transform: translateY(-8px) scale(1.02);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05) 0%, rgba(0, 0, 0, 0.8) 100%);
        }

        .stat-icon {
            font-size: 2.5rem;
            color: #00ff88;
            width: 60px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: #e0e0e0;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #888;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .featured-opportunities h3 {
            color: #00ff88;
            font-size: 1.8rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .featured-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .featured-card {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(15, 15, 15, 0.6) 100%);
            border: 2px solid rgba(0, 255, 136, 0.2);
            border-radius: 18px;
            padding: 25px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .featured-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(0, 255, 136, 0.08) 50%, transparent 100%);
            transition: left 0.6s ease;
        }

        .featured-card:hover::before {
            left: 100%;
        }

        .featured-card:hover {
            border-color: #00ff88;
            box-shadow: 0 15px 35px rgba(0, 255, 136, 0.25), 0 5px 15px rgba(0, 255, 136, 0.1);
            transform: translateY(-6px) scale(1.02);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05) 0%, rgba(0, 0, 0, 0.8) 100%);
        }

        .featured-card:active {
            transform: translateY(-4px) scale(1.01);
            transition: all 0.1s ease;
        }

        .featured-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .featured-symbol {
            font-size: 1.3rem;
            font-weight: 800;
            color: #00ff88;
        }

        .featured-upside {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            padding: 5px 10px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .featured-company {
            color: #ccc;
            margin-bottom: 15px;
        }

        .featured-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e0e0e0;
            margin-bottom: 10px;
        }

        .featured-reason {
            color: #aaa;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .risk-badge {
            background: rgba(255, 68, 68, 0.2);
            color: #ff6b6b;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 700;
            display: inline-block;
            margin-top: 8px;
        }

        /* Watchlist Styles */
        .watchlist-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .watchlist-header h2 {
            color: #00ff88;
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .watchlist-header p {
            color: #ccc;
            font-size: 1.2rem;
        }

        .empty-watchlist {
            text-align: center;
            padding: 80px 20px;
            color: #888;
        }

        .empty-watchlist i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #555;
        }

        .empty-watchlist h3 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #ccc;
        }

        .empty-watchlist p {
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .watchlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .watchlist-card {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(0, 255, 136, 0.2);
            border-radius: 20px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
        }

        .watchlist-card:hover {
            border-color: #00ff88;
            box-shadow: 0 15px 40px rgba(0, 255, 136, 0.2);
            transform: translateY(-5px);
        }

        .watchlist-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .watchlist-symbol {
            font-size: 1.5rem;
            font-weight: 800;
            color: #00ff88;
            letter-spacing: 2px;
        }

        .watchlist-remove {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .watchlist-remove:hover {
            background: rgba(255, 68, 68, 0.4);
        }

        .watchlist-company {
            color: #ccc;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .watchlist-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .watchlist-metric {
            text-align: center;
        }

        .watchlist-metric-label {
            color: #888;
            font-size: 0.8rem;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .watchlist-metric-value {
            color: #e0e0e0;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .watchlist-prediction {
            background: rgba(0, 255, 136, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .watchlist-prediction-label {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .watchlist-prediction-value {
            color: #00ff88;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .watchlist-actions {
            display: flex;
            gap: 10px;
        }

        .watchlist-analyze-btn {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .watchlist-analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 255, 136, 0.4);
        }

        /* Risk Warning Styles */
        .risk-warning-section {
            background: rgba(255, 68, 68, 0.1);
            border: 2px solid rgba(255, 68, 68, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
        }

        .risk-warning-section h4 {
            color: #ff6b6b;
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .risk-warnings {
            margin-bottom: 20px;
        }

        .risk-warning {
            background: rgba(255, 68, 68, 0.15);
            color: #ffaaaa;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #ff6b6b;
            font-weight: 600;
        }

        .risk-warning.extreme {
            background: rgba(255, 0, 0, 0.2);
            border-left-color: #ff0000;
            color: #ffcccc;
            font-size: 1.05rem;
        }

        .risk-disclaimer {
            background: rgba(255, 165, 0, 0.1);
            color: #ffcc99;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffa500;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* AI Reasoning Section Styles */
        .ai-reasoning-section {
            background: rgba(0, 255, 136, 0.05);
            border: 2px solid rgba(0, 255, 136, 0.2);
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
        }

        .ai-reasoning-section h3 {
            color: #00ff88;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .reasoning-content {
            color: #e0e0e0;
            line-height: 1.6;
        }

        .reasoning-factor {
            background: rgba(0, 255, 136, 0.1);
            border-left: 4px solid #00ff88;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .reasoning-factor h4 {
            color: #00ff88;
            font-size: 1.1rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reasoning-factor p {
            color: #ccc;
            margin: 0;
            font-size: 0.95rem;
        }

        .reasoning-summary {
            background: rgba(0, 255, 136, 0.15);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .reasoning-summary h4 {
            color: #00ff88;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .reasoning-summary p {
            color: #e0e0e0;
            margin: 0;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2.5rem; }
            .hero-content h2 { font-size: 2rem; }
            .hero-description { font-size: 1.1rem; }
            .cta-buttons { flex-direction: column; align-items: center; }
            .input-group { flex-direction: column; }
            .prediction-grid { grid-template-columns: 1fr; }
            .charts-section { grid-template-columns: 1fr; }
            .auth-section { position: relative; top: auto; right: auto; margin-bottom: 20px; text-align: center; }
            .features-grid { grid-template-columns: 1fr; }
            .pricing-grid { grid-template-columns: 1fr; }
            .pricing-card.featured { transform: none; }
            .recommendations-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="auth-section">
        <button class="auth-btn" onclick="openModal('signin')">Sign In</button>
        <button class="auth-btn" onclick="openModal('signup')">Sign Up</button>
        <span id="userWelcome" style="display: none; color: #00ff88; margin-right: 20px;">Welcome, <span id="username"></span>!</span>
        <button id="logoutBtn" class="auth-btn" onclick="logout()" style="display: none;">Logout</button>
    </div>

    <div class="container">
        <!-- Landing Page Content -->
        <div id="landingPage">
            <div class="header">
                <h1><i class="fas fa-chart-line"></i> StockTrek</h1>
                <p>AI-Powered Stock Analysis & Market Intelligence</p>
            </div>

            <div class="hero-section">
                <div class="hero-content">
                    <h2>Revolutionize Your Trading with AI</h2>
                    <p class="hero-description">
                        Harness the power of advanced machine learning algorithms to predict stock movements
                        with unprecedented accuracy. Our neural network analyzes thousands of data points
                        to give you the edge in today's volatile markets.
                    </p>
                    <div class="cta-buttons">
                        <button class="cta-btn primary" onclick="openModal('signup')">
                            <i class="fas fa-rocket"></i> Start Free Trial
                        </button>
                        <button class="cta-btn secondary" onclick="openModal('signin')">
                            <i class="fas fa-sign-in-alt"></i> Sign In
                        </button>
                    </div>
                </div>
            </div>

            <div class="features-section">
                <h2 class="section-title">Why Choose StockAI Pro?</h2>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <h3>Advanced AI Models</h3>
                        <p>Our proprietary neural networks process market data, news sentiment, and technical indicators to deliver highly accurate predictions.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>Real-Time Analysis</h3>
                        <p>Get instant predictions with interactive charts showing historical trends and future projections based on AI analysis.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h3>Risk Assessment</h3>
                        <p>Comprehensive risk analysis with confidence scores and volatility metrics to help you make informed decisions.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h3>24/7 Monitoring</h3>
                        <p>Our AI continuously monitors market conditions and updates predictions in real-time for optimal trading opportunities.</p>
                    </div>
                </div>
            </div>

            <div class="pricing-section">
                <h2 class="section-title">Choose Your Plan</h2>
                <div class="pricing-grid">
                    <div class="pricing-card">
                        <h3>Starter</h3>
                        <div class="price">$29<span>/month</span></div>
                        <ul class="features-list">
                            <li><i class="fas fa-check"></i> 50 predictions per month</li>
                            <li><i class="fas fa-check"></i> Basic technical analysis</li>
                            <li><i class="fas fa-check"></i> Email support</li>
                        </ul>
                        <button class="pricing-btn" onclick="openModal('signup')">Get Started</button>
                    </div>
                    <div class="pricing-card featured">
                        <div class="popular-badge">Most Popular</div>
                        <h3>Professional</h3>
                        <div class="price">$79<span>/month</span></div>
                        <ul class="features-list">
                            <li><i class="fas fa-check"></i> Unlimited predictions</li>
                            <li><i class="fas fa-check"></i> Advanced AI analysis</li>
                            <li><i class="fas fa-check"></i> Real-time alerts</li>
                            <li><i class="fas fa-check"></i> Priority support</li>
                        </ul>
                        <button class="pricing-btn" onclick="openModal('signup')">Start Free Trial</button>
                    </div>
                    <div class="pricing-card">
                        <h3>Enterprise</h3>
                        <div class="price">$199<span>/month</span></div>
                        <ul class="features-list">
                            <li><i class="fas fa-check"></i> Everything in Professional</li>
                            <li><i class="fas fa-check"></i> Custom AI models</li>
                            <li><i class="fas fa-check"></i> API access</li>
                            <li><i class="fas fa-check"></i> Dedicated support</li>
                        </ul>
                        <button class="pricing-btn" onclick="openModal('signup')">Contact Sales</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Application (Hidden by default) -->
        <div id="mainApp" style="display: none;">
            <div class="app-container">
                <!-- Sidebar Navigation -->
                <div class="sidebar">
                    <div class="sidebar-header">
                        <h2><i class="fas fa-chart-line"></i> StockTrek</h2>
                    </div>
                    <div class="sidebar-nav">
                        <button class="nav-item active" onclick="switchTab('dashboard')">
                            <i class="fas fa-chart-pie"></i> Dashboard
                        </button>
                        <button class="nav-item" onclick="switchTab('analysis')">
                            <i class="fas fa-search"></i> Analysis
                        </button>
                        <button class="nav-item" onclick="switchTab('watchlist')">
                            <i class="fas fa-star"></i> Watchlist
                        </button>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="main-content">

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <div class="dashboard-hero">
                    <h2>Welcome back, <span id="dashboardUsername"></span>!</h2>
                    <p>Discover AI-powered investment opportunities</p>
                </div>

                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-info">
                            <div class="stat-value" id="sp500Value">Loading...</div>
                            <div class="stat-label">S&P 500 Today</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stat-info">
                            <div class="stat-value" id="vixValue">Loading...</div>
                            <div class="stat-label">VIX Fear Index</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-signal"></i></div>
                        <div class="stat-info">
                            <div class="stat-value" id="activeSignals">Loading...</div>
                            <div class="stat-label">Active Opportunities</div>
                        </div>
                    </div>
                    <!-- Market Insights & Trends -->
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-heart-pulse"></i></div>
                        <div class="stat-info">
                            <div class="stat-value" id="marketSentiment">Loading...</div>
                            <div class="stat-label">Market Sentiment</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-trophy"></i></div>
                        <div class="stat-info">
                            <div class="stat-value" id="topSector">Loading...</div>
                            <div class="stat-label">Top Performing Sector</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-brain"></i></div>
                        <div class="stat-info">
                            <div class="stat-value" id="aiConfidence">Loading...</div>
                            <div class="stat-label">AI Confidence Level</div>
                        </div>
                    </div>
                </div>

                <div class="featured-opportunities">
                    <h3><i class="fas fa-star"></i> Today's Top Opportunities</h3>
                    <div id="featuredGrid" class="featured-grid">
                        <!-- Featured opportunities will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Analysis Tab -->
            <div id="analysisTab" class="tab-content">
                <div class="main-card">
                    <div class="input-section">
                        <div class="input-group">
                            <div class="input-wrapper">
                                <input type="text" id="stockSymbol" class="stock-input" placeholder="Enter Stock Symbol (e.g., AAPL, TSLA)" maxlength="10" autocomplete="off">
                                <div id="stockDropdown" class="stock-dropdown"></div>
                            </div>
                            <div class="timeframe-selector">
                                <label for="timeframeSelect" style="color: #ccc; margin-bottom: 5px; display: block;">
                                    <i class="fas fa-clock"></i> Prediction Timeframe:
                                </label>
                                <select id="timeframeSelect" class="timeframe-select">
                                    <option value="auto">Auto (AI Recommended)</option>
                                    <option value="1month">1 Month</option>
                                    <option value="3months">3 Months</option>
                                    <option value="6months">6 Months</option>
                                    <option value="1year">1 Year</option>
                                    <option value="2years">2 Years</option>
                                </select>
                            </div>
                            <button id="predictBtn" class="predict-btn">
                                <i class="fas fa-brain"></i>
                                Analyze
                            </button>
                        </div>
                    </div>

                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <p>Neural network processing market data...</p>
                    </div>

                    <div id="results" class="results">
                        <!-- Results will be populated here -->
                    </div>

                    <div id="error" class="error" style="display: none;">
                        <!-- Error messages will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Watchlist Tab -->
            <div id="watchlistTab" class="tab-content">
                <div class="watchlist-header">
                    <h2><i class="fas fa-star"></i> Your Watchlist</h2>
                    <p>Track your favorite stocks and monitor AI predictions</p>
                    <button onclick="loadWatchlist()" style="background: #00ff88; color: #000; border: none; padding: 8px 16px; border-radius: 4px; margin-left: 10px;">
                        <i class="fas fa-refresh"></i> Refresh
                    </button>
                </div>
                <div id="watchlistContent" class="watchlist-content">
                    <div class="empty-watchlist">
                        <i class="fas fa-star-o"></i>
                        <h3>Your watchlist is empty</h3>
                        <p>Start by analyzing stocks and adding them to your watchlist</p>
                        <button class="cta-btn primary" onclick="switchTab('analysis')">
                            <i class="fas fa-search"></i> Analyze Stocks
                        </button>
                    </div>
                </div>
            </div>
                </div> <!-- End main-content -->
            </div> <!-- End app-container -->
        </div>

        <!-- Authentication Modals -->
        <div id="signinModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('signin')">&times;</span>
                <h2><i class="fas fa-sign-in-alt"></i> Sign In</h2>
                <form id="signinForm">
                    <div class="form-group">
                        <label for="signinEmail">Email:</label>
                        <input type="email" id="signinEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="signinPassword">Password:</label>
                        <input type="password" id="signinPassword" required>
                    </div>
                    <div id="signinError" class="error" style="display: none;"></div>
                    <button type="submit" class="predict-btn" style="width: 100%; margin-top: 20px;">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </form>
            </div>
        </div>

        <div id="signupModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('signup')">&times;</span>
                <h2><i class="fas fa-user-plus"></i> Sign Up</h2>
                <form id="signupForm">
                    <div class="form-group">
                        <label for="signupName">Full Name:</label>
                        <input type="text" id="signupName" required>
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email:</label>
                        <input type="email" id="signupEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password:</label>
                        <input type="password" id="signupPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="signupConfirmPassword">Confirm Password:</label>
                        <input type="password" id="signupConfirmPassword" required>
                    </div>
                    <div id="signupError" class="error" style="display: none;"></div>
                    <button type="submit" class="predict-btn" style="width: 100%; margin-top: 20px;">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                </form>
            </div>
        </div>

        <!-- Email Verification Modal -->
        <div id="verificationModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('verification')">&times;</span>
                <h2><i class="fas fa-envelope-open"></i> Verify Your Email</h2>
                <p style="margin-bottom: 20px; color: #ccc;">
                    We've sent a 6-digit verification code to <strong id="verificationEmail"></strong>
                </p>
                <form id="verificationForm">
                    <div class="form-group">
                        <label for="verificationCode">Verification Code:</label>
                        <input type="text" id="verificationCode" maxlength="6" placeholder="Enter 6-digit code" required
                               style="text-align: center; font-size: 1.5rem; letter-spacing: 5px;">
                    </div>
                    <div id="verificationError" class="error" style="display: none;"></div>
                    <button type="submit" class="predict-btn" style="width: 100%; margin-top: 20px;">
                        <i class="fas fa-check"></i> Verify Email
                    </button>
                </form>
                <div style="text-align: center; margin-top: 20px;">
                    <button id="resendCodeBtn" class="auth-btn" onclick="resendVerificationCode()" style="background: transparent; border: 1px solid #00ff88;">
                        <i class="fas fa-redo"></i> Resend Code
                    </button>
                </div>
            </div>
        </div>


    </div>

    <script>
        // Initialize global variables first to prevent reference errors
        let stockInput, predictBtn, loading, results, error, stockDropdown;
        let watchlist = JSON.parse(localStorage.getItem('stockWatchlist') || '[]');
        let availableStocks = [];

        function initializeElements() {
            stockInput = document.getElementById('stockSymbol');
            predictBtn = document.getElementById('predictBtn');
            loading = document.getElementById('loading');
            results = document.getElementById('results');
            error = document.getElementById('error');
            stockDropdown = document.getElementById('stockDropdown');

            // Add event listeners
            if (stockInput) {
                stockInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        hideDropdown();
                        predictStock();
                    }
                });

                stockInput.addEventListener('input', function(e) {
                    const query = e.target.value.trim().toUpperCase();
                    if (query.length > 0) {
                        showStockSuggestions(query);
                    } else {
                        hideDropdown();
                    }
                });

                stockInput.addEventListener('blur', function() {
                    setTimeout(hideDropdown, 200);
                });
            }

            if (predictBtn) {
                predictBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Predict button clicked!'); // Debug log
                    predictStock();
                });
                console.log('Predict button event listener added successfully');
            } else {
                console.error('Predict button not found!');
            }
        }

        // Comprehensive stock database covering major market segments
        const stockDatabase = {
            // Large Cap Technology
            'AAPL': { name: 'Apple Inc.', price: 201.50, sector: 'Technology', marketCap: '2.9T', volume: 45000000, pe: 31.2, beta: 1.25 },
            'GOOGL': { name: 'Alphabet Inc.', price: 166.01, sector: 'Technology', marketCap: '1.7T', volume: 28000000, pe: 24.8, beta: 1.15 },
            'MSFT': { name: 'Microsoft Corporation', price: 486.00, sector: 'Technology', marketCap: '2.8T', volume: 32000000, pe: 35.4, beta: 0.95 },
            'TSLA': { name: 'Tesla Inc.', price: 348.68, sector: 'Automotive', marketCap: '1.1T', volume: 85000000, pe: 200.4, beta: 2.46 },
            'AMZN': { name: 'Amazon.com Inc.', price: 208.47, sector: 'E-commerce', marketCap: '1.5T', volume: 38000000, pe: 45.2, beta: 1.33 },
            'NVDA': { name: 'NVIDIA Corporation', price: 144.17, sector: 'Technology', marketCap: '2.1T', volume: 55000000, pe: 46.8, beta: 1.68 },
            'META': { name: 'Meta Platforms Inc.', price: 698.53, sector: 'Technology', marketCap: '825B', volume: 42000000, pe: 28.9, beta: 1.22 },

            // Semiconductors
            'AMD': { name: 'Advanced Micro Devices', price: 129.52, sector: 'Technology', marketCap: '230B', volume: 65000000, pe: 142.3, beta: 1.89 },
            'INTC': { name: 'Intel Corporation', price: 35.75, sector: 'Technology', marketCap: '150B', volume: 48000000, pe: 18.2, beta: 0.67 },
            'ASML': { name: 'ASML Holding NV', price: 756.92, sector: 'Technology', marketCap: '290B', volume: 1200000, pe: 29.6, beta: 1.45 },
            'TSM': { name: 'Taiwan Semiconductor', price: 195.40, sector: 'Technology', marketCap: '510B', volume: 15000000, pe: 22.1, beta: 1.12 },
            'QCOM': { name: 'Qualcomm Inc.', price: 168.25, sector: 'Technology', marketCap: '185B', volume: 8500000, pe: 18.9, beta: 1.34 },

            // Financial Services
            'JPM': { name: 'JPMorgan Chase & Co.', price: 245.80, sector: 'Financial', marketCap: '695B', volume: 12000000, pe: 14.2, beta: 1.15 },
            'BAC': { name: 'Bank of America Corp.', price: 48.95, sector: 'Financial', marketCap: '365B', volume: 35000000, pe: 16.8, beta: 1.28 },
            'WFC': { name: 'Wells Fargo & Company', price: 72.15, sector: 'Financial', marketCap: '245B', volume: 18000000, pe: 13.5, beta: 1.22 },
            'GS': { name: 'Goldman Sachs Group Inc.', price: 598.45, sector: 'Financial', marketCap: '195B', volume: 2800000, pe: 15.9, beta: 1.45 },

            // Healthcare & Biotech
            'JNJ': { name: 'Johnson & Johnson', price: 148.75, sector: 'Healthcare', marketCap: '385B', volume: 8500000, pe: 15.2, beta: 0.68 },
            'PFE': { name: 'Pfizer Inc.', price: 25.85, sector: 'Healthcare', marketCap: '145B', volume: 28000000, pe: 12.8, beta: 0.72 },
            'MRNA': { name: 'Moderna Inc.', price: 42.30, sector: 'Biotech', marketCap: '15B', volume: 8200000, pe: -8.5, beta: 1.85 },
            'GILD': { name: 'Gilead Sciences Inc.', price: 89.65, sector: 'Biotech', marketCap: '110B', volume: 6800000, pe: 16.4, beta: 0.58 },

            // Energy
            'XOM': { name: 'Exxon Mobil Corporation', price: 118.45, sector: 'Energy', marketCap: '485B', volume: 15000000, pe: 14.8, beta: 1.35 },
            'CVX': { name: 'Chevron Corporation', price: 162.30, sector: 'Energy', marketCap: '295B', volume: 8500000, pe: 15.2, beta: 1.18 },
            'COP': { name: 'ConocoPhillips', price: 108.75, sector: 'Energy', marketCap: '135B', volume: 7200000, pe: 12.9, beta: 1.42 },

            // Consumer & Retail
            'WMT': { name: 'Walmart Inc.', price: 95.85, sector: 'Consumer', marketCap: '785B', volume: 8500000, pe: 28.4, beta: 0.52 },
            'HD': { name: 'Home Depot Inc.', price: 415.20, sector: 'Consumer', marketCap: '415B', volume: 3200000, pe: 26.8, beta: 1.05 },
            'COST': { name: 'Costco Wholesale Corp.', price: 985.75, sector: 'Consumer', marketCap: '435B', volume: 1800000, pe: 58.2, beta: 0.78 },
            'NKE': { name: 'Nike Inc.', price: 72.45, sector: 'Consumer', marketCap: '110B', volume: 8500000, pe: 22.8, beta: 1.15 },

            // Growth & Emerging
            'RIVN': { name: 'Rivian Automotive Inc.', price: 14.37, sector: 'Automotive', marketCap: '15B', volume: 25000000, pe: -2.8, beta: 2.15 },
            'PLTR': { name: 'Palantir Technologies', price: 30.25, sector: 'Data Analytics', marketCap: '68B', volume: 45000000, pe: 285.4, beta: 2.34 },
            'RBLX': { name: 'Roblox Corporation', price: 52.80, sector: 'Gaming', marketCap: '35B', volume: 18000000, pe: -15.2, beta: 1.95 },
            'SNOW': { name: 'Snowflake Inc.', price: 115.60, sector: 'Cloud Software', marketCap: '38B', volume: 4200000, pe: -28.5, beta: 1.78 },

            // International
            'BABA': { name: 'Alibaba Group Holding', price: 78.95, sector: 'E-commerce', marketCap: '185B', volume: 18000000, pe: 8.9, beta: 0.85 },
            'TSM': { name: 'Taiwan Semiconductor', price: 195.40, sector: 'Technology', marketCap: '510B', volume: 15000000, pe: 22.1, beta: 1.12 },
            'ASML': { name: 'ASML Holding NV', price: 756.92, sector: 'Technology', marketCap: '290B', volume: 1200000, pe: 29.6, beta: 1.45 },

            // ETFs
            'SPY': { name: 'SPDR S&P 500 ETF', price: 445.20, sector: 'ETF', marketCap: '415B', volume: 75000000, pe: 25.8, beta: 1.0 },
            'QQQ': { name: 'Invesco QQQ Trust', price: 385.60, sector: 'ETF', marketCap: '195B', volume: 45000000, pe: 32.4, beta: 1.15 },
            'IWM': { name: 'iShares Russell 2000 ETF', price: 225.80, sector: 'ETF', marketCap: '85B', volume: 28000000, pe: 45.2, beta: 1.25 }
        };

        // Authentication system
        let currentUser = localStorage.getItem('currentUser');
        if (currentUser) {
            currentUser = JSON.parse(currentUser);
            showUserLoggedIn(currentUser);
            showMainApp();
        }

        // Watchlist and stock data are now initialized at the top of the script

        function openModal(type) {
            document.getElementById(type + 'Modal').style.display = 'block';
            // Clear any existing errors
            const errorElement = document.getElementById(type + 'Error') ||
                               document.querySelector(`#${type}Modal .error`);
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        function closeModal(type) {
            document.getElementById(type + 'Modal').style.display = 'none';
            // Clear any existing errors
            const errorElement = document.getElementById(type + 'Error') ||
                               document.querySelector(`#${type}Modal .error`);
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        function showUserLoggedIn(user) {
            document.getElementById('userWelcome').style.display = 'inline';
            document.getElementById('username').textContent = user.name;
            document.getElementById('logoutBtn').style.display = 'inline';
            document.querySelector('.auth-btn[onclick="openModal(\'signin\')"]').style.display = 'none';
            document.querySelector('.auth-btn[onclick="openModal(\'signup\')"]').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('dashboardUsername').textContent = currentUser.name;
            generateFeaturedOpportunities();
            updateWatchlistCount();
            loadWatchlist(); // Load watchlist items
            loadAvailableStocks(); // Load stocks for dropdown
            loadDashboardStats(); // Load the new dashboard statistics

            // Initialize elements after the main app is shown
            setTimeout(initializeElements, 100);
        }

        function showLandingPage() {
            document.getElementById('landingPage').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            showLandingPage();
            // Reset auth buttons
            document.getElementById('userWelcome').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.querySelector('.auth-btn[onclick="openModal(\'signin\')"]').style.display = 'inline';
            document.querySelector('.auth-btn[onclick="openModal(\'signup\')"]').style.display = 'inline';
        }

        // Form handlers
        document.getElementById('signinForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // Store user data
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    currentUser = data.user;
                    showUserLoggedIn(data.user);
                    closeModal('signin');
                    showMainApp();

                    // Reset form
                    e.target.reset();
                } else {
                    // Show error
                    showAuthError('signin', data.error || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAuthError('signin', 'Network error. Please try again.');
            } finally {
                // Reset button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
            }
        });

        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');

            if (password !== confirmPassword) {
                showAuthError('signup', 'Passwords do not match!');
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // Show verification modal
                    closeModal('signup');
                    showVerificationModal(data.user_id, email);

                    // Reset form
                    e.target.reset();
                } else {
                    // Show error
                    showAuthError('signup', data.error || 'Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showAuthError('signup', 'Network error. Please try again.');
            } finally {
                // Reset button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
            }
        });

        // Verification form handler
        document.getElementById('verificationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const code = document.getElementById('verificationCode').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');

            if (!currentVerificationUserId) {
                showAuthError('verification', 'Session expired. Please register again.');
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

            try {
                const response = await fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentVerificationUserId,
                        code: code
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Store user data and log in
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    currentUser = data.user;
                    showUserLoggedIn(data.user);
                    closeModal('verification');
                    showMainApp();

                    // Reset form
                    e.target.reset();
                    currentVerificationUserId = null;
                } else {
                    // Show error
                    showAuthError('verification', data.error || 'Verification failed');
                }
            } catch (error) {
                console.error('Verification error:', error);
                showAuthError('verification', 'Network error. Please try again.');
            } finally {
                // Reset button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Verify Email';
            }
        });

        // Helper functions for authentication
        let currentVerificationUserId = null;

        function showVerificationModal(userId, email) {
            currentVerificationUserId = userId;
            document.getElementById('verificationEmail').textContent = email;
            document.getElementById('verificationModal').style.display = 'block';
            document.getElementById('verificationCode').focus();
        }

        function showAuthError(modalType, message) {
            const errorElement = document.getElementById(modalType + 'Error') ||
                               document.querySelector(`#${modalType}Modal .error`);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';

                // Hide error after 5 seconds
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }
        }

        async function resendVerificationCode() {
            if (!currentVerificationUserId) {
                showAuthError('verification', 'Session expired. Please register again.');
                return;
            }

            const resendBtn = document.getElementById('resendCodeBtn');
            resendBtn.disabled = true;
            resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            try {
                const response = await fetch('/api/auth/resend-verification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: currentVerificationUserId })
                });

                const data = await response.json();

                if (response.ok) {
                    showAuthError('verification', 'New verification code sent!');
                } else {
                    showAuthError('verification', data.error || 'Failed to resend code');
                }
            } catch (error) {
                console.error('Resend error:', error);
                showAuthError('verification', 'Network error. Please try again.');
            } finally {
                resendBtn.disabled = false;
                resendBtn.innerHTML = '<i class="fas fa-redo"></i> Resend Code';
            }
        }

        // Enter key support
        // Event listeners are now handled in initializeElements()

        // Load available stocks from backend
        async function loadAvailableStocks() {
            try {
                const response = await fetch('/api/stocks/all?limit=1000');
                if (response.ok) {
                    const data = await response.json();
                    availableStocks = data.stocks || [];
                    console.log(`Loaded ${availableStocks.length} stocks for dropdown (source: ${data.source})`);

                    // Sort stocks for better user experience
                    availableStocks.sort((a, b) => {
                        // Popular stocks first, then alphabetical
                        const popularSymbols = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'NVDA', 'META'];
                        const aPopular = popularSymbols.includes(a.symbol);
                        const bPopular = popularSymbols.includes(b.symbol);

                        if (aPopular && !bPopular) return -1;
                        if (!aPopular && bPopular) return 1;
                        return a.symbol.localeCompare(b.symbol);
                    });
                } else {
                    console.error('Failed to load available stocks');
                }
            } catch (error) {
                console.error('Error loading available stocks:', error);
            }
        }

        function showStockSuggestions(query) {
            if (availableStocks.length === 0) {
                // Load stocks if not already loaded
                loadAvailableStocks();
                return;
            }

            const matches = [];

            for (const stock of availableStocks) {
                if (stock.symbol.startsWith(query) ||
                    stock.name.toUpperCase().includes(query) ||
                    stock.sector.toUpperCase().includes(query)) {
                    matches.push({
                        symbol: stock.symbol,
                        data: {
                            name: stock.name,
                            sector: stock.sector
                        }
                    });
                }
            }

            if (matches.length === 0) {
                hideDropdown();
                return;
            }

            // Sort matches - exact symbol matches first, then alphabetical
            matches.sort((a, b) => {
                if (a.symbol === query) return -1;
                if (b.symbol === query) return 1;
                if (a.symbol.startsWith(query) && !b.symbol.startsWith(query)) return -1;
                if (b.symbol.startsWith(query) && !a.symbol.startsWith(query)) return 1;
                return a.symbol.localeCompare(b.symbol);
            });

            const html = matches.slice(0, 8).map(match => `
                <div class="stock-dropdown-item" onclick="selectStock('${match.symbol}')">
                    <span class="dropdown-symbol">${match.symbol}</span>
                    <span class="dropdown-name">${match.data.name}</span>
                    <span class="dropdown-sector">${match.data.sector}</span>
                </div>
            `).join('');

            stockDropdown.innerHTML = html;
            stockDropdown.style.display = 'block';
        }

        function selectStock(symbol) {
            stockInput.value = symbol;
            hideDropdown();
            stockInput.focus();
        }

        function hideDropdown() {
            stockDropdown.style.display = 'none';
        }

        // Seeded random number generator for consistent results
        function seededRandom(seed) {
            const x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        function generateHistoricalData(symbol, currentPrice, days = 30) {
            const data = [];
            let price = currentPrice * 0.9; // Start 10% lower
            const baseSeed = symbol.charCodeAt(0) * 1000; // Use symbol for consistent seed

            for (let i = 0; i < days; i++) {
                const seed = baseSeed + i;
                const change = (seededRandom(seed) - 0.5) * 0.05; // ±2.5% daily change
                price = price * (1 + change);
                data.push({
                    date: new Date(Date.now() - (days - i) * 24 * 60 * 60 * 1000),
                    price: parseFloat(price.toFixed(2))
                });
            }

            return data;
        }

        function generatePredictionData(symbol, currentPrice, expectedChange, days = 30) {
            const data = [];
            const totalChange = expectedChange / 100;
            const dailyChange = totalChange / days;
            let price = currentPrice;
            const baseSeed = symbol.charCodeAt(0) * 2000; // Different seed for predictions

            for (let i = 0; i <= days; i++) {
                const seed = baseSeed + i;
                const randomness = (seededRandom(seed) - 0.5) * 0.02; // ±1% randomness
                price = price * (1 + dailyChange + randomness);
                data.push({
                    date: new Date(Date.now() + i * 24 * 60 * 60 * 1000),
                    price: parseFloat(price.toFixed(2))
                });
            }

            return data;
        }

        function generatePrediction(symbol, stockData) {
            // Create consistent seed based on stock symbol
            const symbolSeed = symbol.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);

            // Enhanced AI simulation with deterministic results based on symbol
            const volatilitySeed = seededRandom(symbolSeed * 1.1);
            const volatility = volatilitySeed * 0.4 + 0.15; // 15-55% volatility

            const sentimentSeed = seededRandom(symbolSeed * 1.3);
            const marketSentiment = sentimentSeed * 2 - 1; // -1 to 1

            const sectorMultiplier = {
                'Technology': 1.3,
                'Automotive': 1.1,
                'E-commerce': 1.2,
                'Entertainment': 0.9,
                'ETF': 0.7
            }[stockData.sector] || 1.0;

            // Multi-factor prediction model with consistent seeds
            const technicalSeed = seededRandom(symbolSeed * 1.7);
            const fundamentalSeed = seededRandom(symbolSeed * 2.1);
            const sectorSeed = seededRandom(symbolSeed * 2.9);

            const technicalFactor = (technicalSeed - 0.5) * 8; // ±4%
            const fundamentalFactor = (fundamentalSeed - 0.5) * 6; // ±3%
            const sentimentFactor = marketSentiment * 5; // ±5%
            const sectorFactor = (sectorSeed - 0.5) * 4 * sectorMultiplier; // ±2% * multiplier

            let expectedChange = technicalFactor + fundamentalFactor + sentimentFactor + sectorFactor;

            // Track if this is an extreme prediction before capping
            const isExtremePrediction = Math.abs(expectedChange) > 25;
            const originalChange = expectedChange;

            // Cap extreme predictions to realistic ranges (-25% to +25%)
            expectedChange = Math.max(-25, Math.min(25, expectedChange));
            const targetPrice = stockData.price * (1 + expectedChange / 100);

            // Risk assessment
            const isPennyStock = stockData.price < 10;
            const isHighVolatility = (stockData.beta || 1.0) > 1.8;
            const isSmallCap = stockData.marketCap && (stockData.marketCap.includes('M') ||
                (stockData.marketCap.includes('B') && parseFloat(stockData.marketCap) < 5));

            const riskFactors = [];
            if (isPennyStock) riskFactors.push("penny_stock");
            if (isHighVolatility) riskFactors.push("high_volatility");
            if (isSmallCap) riskFactors.push("small_cap");
            if (isExtremePrediction) riskFactors.push("extreme_prediction");
            if (Math.abs(expectedChange) > 15) riskFactors.push("high_risk");

            let prediction, confidence;
            if (expectedChange > 8) {
                prediction = "STRONG BUY";
                confidence = 88 + seededRandom(symbolSeed * 3.1) * 10;
            } else if (expectedChange > 3) {
                prediction = "BUY";
                confidence = 78 + seededRandom(symbolSeed * 3.3) * 15;
            } else if (expectedChange > -3) {
                prediction = "HOLD";
                confidence = 65 + seededRandom(symbolSeed * 3.7) * 20;
            } else if (expectedChange > -8) {
                prediction = "SELL";
                confidence = 75 + seededRandom(symbolSeed * 4.1) * 15;
            } else {
                prediction = "STRONG SELL";
                confidence = 85 + seededRandom(symbolSeed * 4.3) * 12;
            }

            // Reduce confidence for high-risk predictions
            if (riskFactors.length > 0) {
                confidence = Math.max(45, confidence - (riskFactors.length * 8));
            }

            // Enhanced technical indicators with consistent values
            const rsiSeed = seededRandom(symbolSeed * 5.1);
            const sma20Seed = seededRandom(symbolSeed * 5.3);
            const sma50Seed = seededRandom(symbolSeed * 5.7);
            const macdSeed = seededRandom(symbolSeed * 6.1);

            const rsi = 25 + rsiSeed * 50; // 25-75 RSI
            const sma20 = stockData.price * (0.92 + sma20Seed * 0.16);
            const sma50 = stockData.price * (0.85 + sma50Seed * 0.3);
            const macd = (macdSeed - 0.5) * 10;
            const bollinger = {
                upper: stockData.price * 1.05,
                lower: stockData.price * 0.95
            };

            return {
                symbol: symbol,
                company_name: stockData.name,
                current_price: stockData.price,
                prediction: prediction,
                expected_change_percent: parseFloat(expectedChange.toFixed(2)),
                target_price: parseFloat(targetPrice.toFixed(2)),
                confidence: parseFloat(confidence.toFixed(1)),
                timeframe: "1-3 months",
                market_cap: stockData.marketCap,
                volume: stockData.volume,
                risk_factors: riskFactors,
                original_prediction: isExtremePrediction ? parseFloat(originalChange.toFixed(2)) : null,
                technical_indicators: {
                    rsi: parseFloat(rsi.toFixed(2)),
                    sma_20: parseFloat(sma20.toFixed(2)),
                    sma_50: parseFloat(sma50.toFixed(2)),
                    macd: parseFloat(macd.toFixed(2)),
                    bollinger_upper: parseFloat(bollinger.upper.toFixed(2)),
                    bollinger_lower: parseFloat(bollinger.lower.toFixed(2)),
                    volatility: parseFloat((volatility * 100).toFixed(2))
                },
                historical_data: generateHistoricalData(symbol, stockData.price),
                prediction_data: generatePredictionData(symbol, stockData.price, expectedChange),
                analysis_date: new Date().toLocaleString()
            };
        }

        async function testAPI() {
            console.log('Testing API connection...');
            try {
                const response = await fetch('/api/test');
                const data = await response.json();
                console.log('API test result:', data);
                alert(`API Test: ${data.status} - ${data.message}`);
            } catch (error) {
                console.error('API test failed:', error);
                alert(`API Test Failed: ${error.message}`);
            }
        }

        async function predictStock() {
            console.log('predictStock function called'); // Debug log

            if (!stockInput) {
                console.error('Stock input element not found');
                initializeElements();
                return;
            }

            const symbol = stockInput.value.trim().toUpperCase();
            const timeframe = document.getElementById('timeframeSelect').value;
            console.log('Symbol entered:', symbol, 'Timeframe:', timeframe); // Debug log

            if (!symbol) {
                showError('Please enter a stock symbol');
                return;
            }

            // Show loading state
            loading.style.display = 'block';
            results.style.display = 'none';
            error.style.display = 'none';
            predictBtn.disabled = true;

            try {
                console.log('Making API call to /api/predict with symbol:', symbol);

                // Call the backend API for real predictions
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        timeframe: timeframe
                    })
                });

                console.log('API response status:', response.status);
                console.log('API response headers:', response.headers);

                if (!response.ok) {
                    console.error('API response not ok:', response.status, response.statusText);
                }

                const data = await response.json();
                console.log('API response data:', data);

                if (response.ok && !data.error) {
                    // Show the real prediction results
                    showResults(data);
                } else {
                    // Show error message
                    showError(data.error || `API Error: ${response.status} ${response.statusText}`);
                }

            } catch (error) {
                console.error('Prediction error details:', error);
                console.error('Error type:', error.name);
                console.error('Error message:', error.message);

                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showError('Cannot connect to server. Please check if the application is running properly.');
                } else if (error.name === 'SyntaxError') {
                    showError('Server returned invalid response. Please try again.');
                } else {
                    showError(`Network error: ${error.message}. Please check your connection and try again.`);
                }
            } finally {
                // Hide loading state
                loading.style.display = 'none';
                predictBtn.disabled = false;
            }
        }

        function createPriceChart(historical, prediction, containerId) {
            const ctx = document.getElementById(containerId).getContext('2d');

            // Handle both old and new data formats
            const historicalLabels = historical.map(d => {
                const date = typeof d.date === 'string' ? new Date(d.date) : d.date;
                return date.toLocaleDateString();
            });

            const predictionLabels = prediction ? prediction.map(d => {
                const date = typeof d.date === 'string' ? new Date(d.date) : d.date;
                return date.toLocaleDateString();
            }) : [];

            const allLabels = [...historicalLabels, ...predictionLabels];

            const historicalPrices = historical.map(d => d.price);
            const predictionPrices = prediction && prediction.length > 0 ?
                [historical[historical.length - 1].price, ...prediction.map(d => d.price)] : [];

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allLabels,
                    datasets: [{
                        label: 'Historical Price',
                        data: [...historicalPrices, ...Array(predictionLabels.length).fill(null)],
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'AI Prediction',
                        data: [...Array(historical.length).fill(null), ...predictionPrices],
                        borderColor: '#ffaa00',
                        backgroundColor: 'rgba(255, 170, 0, 0.1)',
                        borderWidth: 3,
                        borderDash: [5, 5],
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(136, 136, 136, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(136, 136, 136, 0.1)' }
                        }
                    }
                }
            });
        }

        function createVolumeChart(data, symbol, containerId) {
            const ctx = document.getElementById(containerId).getContext('2d');

            // Use real volume data from backend if available
            const volumeData = data.map(d => d.volume || 0);
            const labels = data.map(d => {
                const date = typeof d.date === 'string' ? new Date(d.date) : d.date;
                return date.toLocaleDateString();
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Volume',
                        data: volumeData,
                        backgroundColor: 'rgba(0, 255, 136, 0.3)',
                        borderColor: '#00ff88',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(136, 136, 136, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(136, 136, 136, 0.1)' }
                        }
                    }
                }
            });
        }

        function showResults(data) {
            console.log('Showing results for data:', data); // Debug log

            const changeClass = data.expected_change_percent > 0 ? 'positive' :
                               data.expected_change_percent < 0 ? 'negative' : 'neutral';

            const predictionClass = data.prediction.toLowerCase().includes('buy') ? 'buy' :
                                   data.prediction.toLowerCase().includes('sell') ? 'sell' : 'hold';

            results.innerHTML = `
                <div class="stock-header">
                    <div class="company-name">${data.company_name}</div>
                    <div class="stock-symbol">
                        ${data.symbol} • ${data.exchange}
                        ${data.market_cap ? '• $' + (data.market_cap / 1000000000).toFixed(1) + 'B Market Cap' : ''}
                        ${data.is_penny_stock ? '• <span style="color: #ff4444;">PENNY STOCK</span>' : ''}
                    </div>
                    <div style="color: #888; margin-top: 5px;">
                        ${data.sector} • ${data.industry} • ${data.stock_category?.toUpperCase().replace('_', ' ')}
                    </div>
                </div>

                <div class="prediction-grid">
                    <div class="metric-card">
                        <div class="metric-label">Current Price</div>
                        <div class="metric-value">$${data.current_price}</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Neural Network Prediction</div>
                        <div class="metric-value">
                            <span class="prediction-badge ${predictionClass}">${data.prediction}</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Expected Change</div>
                        <div class="metric-value ${changeClass}">
                            ${data.expected_change_percent > 0 ? '+' : ''}${data.expected_change_percent}%
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Target Price</div>
                        <div class="metric-value ${changeClass}">$${data.target_price}</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">AI Confidence</div>
                        <div class="metric-value">${data.confidence}%</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Timeframe</div>
                        <div class="metric-value">${data.timeframe}</div>
                    </div>
                </div>



                <div class="ai-reasoning-section">
                    <h3><i class="fas fa-brain"></i> AI Market Analysis & Reasoning</h3>
                    <div class="reasoning-content">
                        ${generateAIReasoning(data)}
                    </div>
                </div>

                <div class="charts-section">
                    <div class="chart-container">
                        <div class="chart-title">Price Analysis & Prediction</div>
                        <canvas id="priceChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Volume Analysis</div>
                        <canvas id="volumeChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <div class="technical-indicators">
                    <h3 style="margin-bottom: 25px; color: #00ff88; font-size: 1.5rem;">
                        <i class="fas fa-chart-line"></i> Technical Analysis
                    </h3>
                    <div class="indicators-grid">
                        <div class="indicator">
                            <span class="indicator-label">Current Price:</span>
                            <span class="indicator-value">$${data.technical_indicators?.current_price?.toFixed(2) || 'N/A'}</span>
                        </div>
                        <div class="indicator">
                            <span class="indicator-label">RSI (14):</span>
                            <span class="indicator-value">${data.technical_indicators?.rsi?.toFixed(2) || 'N/A'}</span>
                        </div>
                        <div class="indicator">
                            <span class="indicator-label">20-Day SMA:</span>
                            <span class="indicator-value">$${data.technical_indicators?.sma_20?.toFixed(2) || 'N/A'}</span>
                        </div>
                        <div class="indicator">
                            <span class="indicator-label">50-Day SMA:</span>
                            <span class="indicator-value">$${data.technical_indicators?.sma_50?.toFixed(2) || 'N/A'}</span>
                        </div>
                        <div class="indicator">
                            <span class="indicator-label">MACD Signal:</span>
                            <span class="indicator-value">${data.technical_indicators?.macd?.toFixed(4) || 'N/A'}</span>
                        </div>
                        <div class="indicator">
                            <span class="indicator-label">Price Momentum:</span>
                            <span class="indicator-value">${data.technical_indicators?.price_momentum?.toFixed(2) || 'N/A'}%</span>
                        </div>
                        <div class="indicator">
                            <span class="indicator-label">Trend Strength:</span>
                            <span class="indicator-value">${data.technical_indicators?.trend_strength?.toFixed(2) || 'N/A'}%</span>
                        </div>
                        <div class="indicator">
                            <span class="indicator-label">Volume Trend:</span>
                            <span class="indicator-value">${data.technical_indicators?.volume_trend?.toFixed(1) || 'N/A'}%</span>
                        </div>
                        <div class="indicator">
                            <span class="indicator-label">Bollinger Upper:</span>
                            <span class="indicator-value">$${data.technical_indicators?.bollinger_upper?.toFixed(2) || 'N/A'}</span>
                        </div>
                        <div class="indicator">
                            <span class="indicator-label">Bollinger Lower:</span>
                            <span class="indicator-value">$${data.technical_indicators?.bollinger_lower?.toFixed(2) || 'N/A'}</span>
                        </div>
                        <div class="indicator">
                            <span class="indicator-label">Daily Volume:</span>
                            <span class="indicator-value">${data.technical_indicators?.volume?.toLocaleString() || 'N/A'}</span>
                        </div>
                        <div class="indicator">
                            <span class="indicator-label">Volatility:</span>
                            <span class="indicator-value">${data.technical_indicators?.volatility?.toFixed(2) || 'N/A'}%</span>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 25px;">
                        <button class="predict-btn" onclick="addToWatchlist('${data.symbol}', stockDatabase['${data.symbol}'] || {name: '${data.symbol}', price: ${data.technical_indicators?.current_price || 0}}, ${JSON.stringify(data).replace(/"/g, '&quot;')})">
                            <i class="fas fa-star"></i> Add to Watchlist
                        </button>
                    </div>

                    <p style="margin-top: 25px; font-size: 1rem; color: #888; text-align: center;">
                        <i class="fas fa-microchip"></i> Neural network analysis completed: ${data.analysis_date}
                    </p>
                </div>
            `;

            results.style.display = 'block';

            // Create charts after DOM is updated (with error handling)
            setTimeout(() => {
                try {
                    if (data.historical_data && data.historical_data.length > 0) {
                        createPriceChart(data.historical_data, data.prediction_data, 'priceChart');
                        console.log('Price chart created successfully');
                    } else {
                        console.log('No historical data available for price chart');
                    }

                    if (data.volume_data && data.volume_data.length > 0) {
                        createVolumeChart(data.volume_data, data.symbol, 'volumeChart');
                        console.log('Volume chart created successfully');
                    } else {
                        console.log('No volume data available for volume chart');
                    }
                } catch (error) {
                    console.error('Error creating charts:', error);
                }
            }, 100);
        }

        function showError(message) {
            error.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            error.style.display = 'block';
            results.style.display = 'none';
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const signinModal = document.getElementById('signinModal');
            const signupModal = document.getElementById('signupModal');
            const verificationModal = document.getElementById('verificationModal');

            if (event.target === signinModal) {
                closeModal('signin');
            }
            if (event.target === signupModal) {
                closeModal('signup');
            }
            if (event.target === verificationModal) {
                closeModal('verification');
            }
        });

        // Auto-focus on input when page loads
        window.addEventListener('load', () => {
            stockInput.focus();
        });

        // Tab Management
        function switchTab(tabName) {
            // Remove active class from all navigation items and content
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to selected navigation item and content
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Load content based on tab
            if (tabName === 'watchlist') {
                loadWatchlist();
            } else if (tabName === 'analysis') {
                // Reinitialize elements when switching to analysis tab
                setTimeout(initializeElements, 50);
            } else if (tabName === 'dashboard') {
                // Load dashboard stats when switching to dashboard
                loadDashboardStats();
            }
        }

        // Utility Functions
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;

            // Add styles
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#00ff88' : type === 'error' ? '#ff4444' : '#0088ff'};
                color: #000;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 8px;
                animation: slideIn 0.3s ease-out;
            `;

            // Add to page
            document.body.appendChild(notification);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Watchlist Management Functions
        function addToWatchlist(symbol, data, prediction) {
            try {
                // Ensure we have valid data
                if (!symbol) {
                    console.error('Cannot add to watchlist: symbol is required');
                    return;
                }

                // Provide fallback data if not available
                const stockData = data || {
                    name: symbol,
                    price: prediction?.technical_indicators?.current_price || 0
                };

                const existingIndex = watchlist.findIndex(item => item.symbol === symbol);
                const watchlistItem = {
                    symbol,
                    data: stockData,
                    prediction,
                    addedDate: new Date().toISOString()
                };

                if (existingIndex >= 0) {
                    watchlist[existingIndex] = watchlistItem;
                    console.log(`Updated ${symbol} in watchlist`);
                } else {
                    watchlist.push(watchlistItem);
                    console.log(`Added ${symbol} to watchlist`);
                }

                localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
                updateWatchlistCount();

                // Refresh watchlist display if currently viewing it
                if (document.querySelector('.tab-btn.active')?.textContent.includes('Watchlist')) {
                    loadWatchlist();
                }

                // Show success feedback
                showNotification(`${symbol} added to watchlist!`, 'success');

            } catch (error) {
                console.error('Error adding to watchlist:', error);
                showNotification('Failed to add to watchlist', 'error');
            }
        }

        function removeFromWatchlist(symbol) {
            watchlist = watchlist.filter(item => item.symbol !== symbol);
            localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
            updateWatchlistCount();
            loadWatchlist();
        }

        function updateWatchlistCount() {
            const watchlistCountElement = document.getElementById('watchlistCount');
            if (watchlistCountElement) {
                watchlistCountElement.textContent = watchlist.length;
            }
        }

        function loadWatchlist() {
            console.log('loadWatchlist called, watchlist length:', watchlist.length);
            console.log('watchlist data:', watchlist);

            const content = document.getElementById('watchlistContent');
            if (!content) {
                console.error('watchlistContent element not found!');
                return;
            }

            if (watchlist.length === 0) {
                content.innerHTML = `
                    <div class="empty-watchlist">
                        <i class="fas fa-star-o"></i>
                        <h3>Your watchlist is empty</h3>
                        <p>Start by analyzing stocks and adding them to your watchlist</p>
                        <button class="cta-btn primary" onclick="switchTab('analysis')">
                            <i class="fas fa-search"></i> Analyze Stocks
                        </button>
                    </div>
                `;
                return;
            }

            console.log('Rendering watchlist with', watchlist.length, 'items');

            try {
                content.innerHTML = `
                    <div class="watchlist-grid">
                        ${watchlist.map((item, index) => {
                            console.log(`Rendering item ${index}:`, item);

                            // Safe data extraction with fallbacks
                            const symbol = item.symbol || 'Unknown';
                            const companyName = item.data?.name || item.prediction?.company_name || symbol;
                            const currentPrice = item.data?.price || item.prediction?.current_price || item.prediction?.technical_indicators?.current_price || 0;
                            const targetPrice = item.prediction?.target_price || 0;
                            const prediction = item.prediction?.prediction || 'N/A';
                            const expectedChange = item.prediction?.expected_change || item.prediction?.expected_change_percent || 0;

                            return `
                        <div class="watchlist-card">
                            <div class="watchlist-header-row">
                                <div class="watchlist-symbol">${symbol}</div>
                                <button class="watchlist-remove" onclick="removeFromWatchlist('${symbol}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="watchlist-company">${companyName}</div>
                            <div class="watchlist-metrics">
                                <div class="watchlist-metric">
                                    <div class="watchlist-metric-label">Current Price</div>
                                    <div class="watchlist-metric-value">$${currentPrice.toFixed(2)}</div>
                                </div>
                                <div class="watchlist-metric">
                                    <div class="watchlist-metric-label">Target Price</div>
                                    <div class="watchlist-metric-value">$${targetPrice.toFixed(2)}</div>
                                </div>
                            </div>
                            <div class="watchlist-prediction">
                                <div class="watchlist-prediction-label">AI Prediction</div>
                                <div class="watchlist-prediction-value">${prediction} (${expectedChange > 0 ? '+' : ''}${expectedChange.toFixed(1)}%)</div>
                            </div>
                            <div class="watchlist-actions">
                                <button class="watchlist-analyze-btn" onclick="analyzeWatchlistStock('${symbol}')">
                                    <i class="fas fa-chart-line"></i> Re-analyze
                                </button>
                            </div>
                        </div>
                    `;
                        }).join('')}
                    </div>
                `;
                console.log('Watchlist rendered successfully');
            } catch (error) {
                console.error('Error rendering watchlist:', error);
                content.innerHTML = `
                    <div style="text-align: center; color: #ff4444; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Error loading watchlist. Please try refreshing the page.</p>
                    </div>
                `;
            }
        }

        function analyzeWatchlistStock(symbol) {
            switchTab('analysis');
            document.getElementById('stockSymbol').value = symbol;
            predictStock();
        }

        // Dashboard Statistics Functions
        async function loadDashboardStats() {
            console.log('Loading dashboard statistics...');

            // Load all stats simultaneously
            loadSP500Data();
            loadVIXData();
            loadActiveSignals();
            loadMarketSentiment();
            loadTopSector();
            loadAIConfidence();
        }

        function loadSP500Data() {
            console.log('Loading S&P 500 data...');
            // Realistic S&P 500 data simulation with daily-changing but consistent values
            const today = new Date().toDateString(); // Get today's date as string
            const dailySeed = today.split('').reduce((acc, char) => acc + char.charCodeAt(0), 12345); // Create daily seed
            const baseValue = 4750;
            const change = (seededRandom(dailySeed) - 0.4) * 60; // Slight bias toward positive, daily seed
            const currentValue = baseValue + change;
            const changePercent = (change / baseValue * 100).toFixed(2);
            const changeClass = change >= 0 ? 'positive' : 'negative';
            const changeSign = change >= 0 ? '+' : '';

            setTimeout(() => {
                const element = document.getElementById('sp500Value');
                if (element) {
                    element.innerHTML = `
                        <span class="${changeClass}">${currentValue.toFixed(0)}</span>
                        <small style="font-size: 0.7em; display: block;">${changeSign}${changePercent}%</small>
                    `;
                    console.log('S&P 500 data loaded successfully');
                } else {
                    console.error('sp500Value element not found');
                }
            }, 10); // Much faster loading
        }

        function loadVIXData() {
            console.log('Loading VIX data...');
            // Realistic VIX data simulation with daily-changing but consistent values
            const today = new Date().toDateString(); // Get today's date as string
            const dailySeed = today.split('').reduce((acc, char) => acc + char.charCodeAt(0), 23456); // Create daily seed
            const vixValue = (seededRandom(dailySeed) * 25 + 12).toFixed(1); // Daily between 12-37
            let vixLabel = 'Low Fear';
            let vixClass = 'positive';

            if (vixValue > 30) {
                vixLabel = 'High Fear';
                vixClass = 'negative';
            } else if (vixValue > 20) {
                vixLabel = 'Moderate';
                vixClass = 'neutral';
            }

            setTimeout(() => {
                const element = document.getElementById('vixValue');
                if (element) {
                    element.innerHTML = `
                        <span class="${vixClass}">${vixValue}</span>
                        <small style="font-size: 0.7em; display: block;">${vixLabel}</small>
                    `;
                    console.log('VIX data loaded successfully');
                } else {
                    console.error('vixValue element not found');
                }
            }, 20); // Much faster loading
        }

        function loadActiveSignals() {
            console.log('Loading active signals...');
            // Count active opportunities based on actual strong signals with daily-changing values
            const today = new Date().toDateString(); // Get today's date as string
            const dailySeed = today.split('').reduce((acc, char) => acc + char.charCodeAt(0), 34567); // Create daily seed
            const signalCount = Math.floor(seededRandom(dailySeed) * 12 + 8); // Daily between 8-20

            setTimeout(() => {
                const element = document.getElementById('activeSignals');
                if (element) {
                    element.innerHTML = `
                        <span class="positive">${signalCount}</span>
                        <small style="font-size: 0.7em; display: block;">Strong Buys</small>
                    `;
                    console.log('Active signals loaded successfully');
                } else {
                    console.error('activeSignals element not found');
                }
            }, 30); // Much faster loading
        }

        function loadMarketSentiment() {
            console.log('Loading market sentiment...');
            // Realistic market sentiment with daily-changing values
            const sentiments = [
                { label: 'Bullish', class: 'positive', emoji: '🐂', weight: 0.5 },
                { label: 'Cautious', class: 'neutral', emoji: '⚖️', weight: 0.3 },
                { label: 'Bearish', class: 'negative', emoji: '🐻', weight: 0.2 }
            ];

            const today = new Date().toDateString(); // Get today's date as string
            const dailySeed = today.split('').reduce((acc, char) => acc + char.charCodeAt(0), 45678); // Create daily seed
            const rand = seededRandom(dailySeed); // Use daily seed
            let sentiment;
            if (rand < 0.5) sentiment = sentiments[0]; // Bullish
            else if (rand < 0.8) sentiment = sentiments[1]; // Cautious
            else sentiment = sentiments[2]; // Bearish

            setTimeout(() => {
                const element = document.getElementById('marketSentiment');
                if (element) {
                    element.innerHTML = `
                        <span class="${sentiment.class}">${sentiment.emoji}</span>
                        <small style="font-size: 0.7em; display: block;">${sentiment.label}</small>
                    `;
                    console.log('Market sentiment loaded successfully');
                } else {
                    console.error('marketSentiment element not found');
                }
            }, 40); // Much faster loading
        }

        function loadTopSector() {
            console.log('Loading top sector...');
            // Realistic sector performance with daily-changing values
            const sectors = [
                { name: 'Technology', change: '+2.8%' },
                { name: 'AI & Robotics', change: '+4.2%' },
                { name: 'Clean Energy', change: '+3.5%' },
                { name: 'Biotech', change: '+2.1%' },
                { name: 'Fintech', change: '+1.9%' },
                { name: 'Healthcare', change: '+3.1%' },
                { name: 'Cybersecurity', change: '+2.9%' },
                { name: 'Cloud Computing', change: '+3.7%' }
            ];

            const today = new Date().toDateString(); // Get today's date as string
            const dailySeed = today.split('').reduce((acc, char) => acc + char.charCodeAt(0), 56789); // Create daily seed
            const topSector = sectors[Math.floor(seededRandom(dailySeed) * sectors.length)]; // Use daily seed

            setTimeout(() => {
                const element = document.getElementById('topSector');
                if (element) {
                    element.innerHTML = `
                        <span class="positive">${topSector.name}</span>
                        <small style="font-size: 0.7em; display: block;">${topSector.change}</small>
                    `;
                    console.log('Top sector loaded successfully');
                } else {
                    console.error('topSector element not found');
                }
            }, 50); // Much faster loading
        }

        function loadAIConfidence() {
            console.log('Loading AI confidence...');
            // More realistic AI confidence level with daily-changing values
            const today = new Date().toDateString(); // Get today's date as string
            const dailySeed = today.split('').reduce((acc, char) => acc + char.charCodeAt(0), 67890); // Create daily seed
            const confidence = Math.floor(seededRandom(dailySeed) * 20 + 65); // Daily between 65-85 (more realistic)
            let confidenceLabel = 'High';
            let confidenceClass = 'positive';

            if (confidence < 70) {
                confidenceLabel = 'Moderate';
                confidenceClass = 'neutral';
            } else if (confidence > 80) {
                confidenceLabel = 'Very High';
                confidenceClass = 'positive';
            }

            setTimeout(() => {
                const element = document.getElementById('aiConfidence');
                if (element) {
                    element.innerHTML = `
                        <span class="${confidenceClass}">${confidence}%</span>
                        <small style="font-size: 0.7em; display: block;">${confidenceLabel}</small>
                    `;
                    console.log('AI confidence loaded successfully');
                } else {
                    console.error('aiConfidence element not found');
                }
            }, 60); // Much faster loading
        }

        // Featured Opportunities (smart algorithm for best growth + safety)
        async function generateFeaturedOpportunities() {
            console.log('Generating featured opportunities...');

            // Show loading state
            const grid = document.getElementById('featuredGrid');
            grid.innerHTML = `
                <div style="text-align: center; color: #888; padding: 40px;">
                    <i class="fas fa-chart-line" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>Loading featured opportunities...</p>
                </div>
            `;

            // High-Growth Opportunities & Emerging Leaders (Expanded for Better Growth Potential)
            const stockCandidates = [
                // AI & Machine Learning Leaders
                'NVDA', 'AMD', 'PLTR', 'C3AI', 'AI', 'SOUN', 'BBAI', 'UPST', 'PATH', 'SMCI', 'AVGO', 'MRVL', 'QCOM', 'INTC',
                // Quantum Computing & Advanced Tech
                'IBM', 'GOOGL', 'IONQ', 'RGTI', 'QUBT', 'ARQQ', 'QMCO', 'QTUM', 'MVIS', 'LAZR', 'VLDR', 'OUST', 'LIDR', 'AEYE',
                // Space Technology & Aerospace
                'RKLB', 'SPCE', 'ASTR', 'PL', 'IRDM', 'MAXR', 'SATS', 'LUNR', 'VORB', 'ASTS', 'GSAT', 'BA', 'LMT', 'RTX',
                // Cybersecurity & Data Protection
                'CRWD', 'ZS', 'NET', 'PANW', 'FTNT', 'CYBR', 'OKTA', 'S', 'TENB', 'VRNS', 'FEYE', 'CHKP', 'QLYS', 'RPD',
                // Biotech & Gene Therapy Innovation
                'MRNA', 'BNTX', 'CRSP', 'EDIT', 'BEAM', 'NTLA', 'BLUE', 'SGMO', 'FATE', 'VCYT', 'PACB', 'ILMN', 'NVTA', 'CDNA',
                // Electric Vehicles & Battery Tech
                'TSLA', 'RIVN', 'LCID', 'NIO', 'XPEV', 'LI', 'CHPT', 'BLNK', 'QS', 'SLDP', 'BYDDY', 'GOEV', 'RIDE', 'NKLA',
                // Fintech & Digital Banking Disruptors
                'SOFI', 'AFRM', 'HOOD', 'SQ', 'COIN', 'PYPL', 'ADYEN', 'LC', 'UPST', 'BILL', 'PAYO', 'STNE', 'NU', 'OPEN',
                // Cloud Computing & SaaS Growth
                'SNOW', 'DDOG', 'MDB', 'ESTC', 'SPLK', 'NOW', 'WDAY', 'TEAM', 'ATLASSIAN', 'ZM', 'DOCU', 'TWLO', 'HUBS', 'ZI',
                // Gaming & Metaverse
                'RBLX', 'U', 'EA', 'TTWO', 'ATVI', 'DKNG', 'PENN', 'SKLZ', 'SLGG', 'GMBL', 'FUBO', 'NFLX', 'DIS', 'META',
                // Clean Energy & Sustainability
                'ENPH', 'SEDG', 'PLUG', 'FCEL', 'BE', 'NOVA', 'RUN', 'SPWR', 'MAXN', 'CSIQ', 'JKS', 'ARRY', 'VSLR', 'SUNW',
                // E-commerce & Digital Platforms
                'SHOP', 'ETSY', 'CHWY', 'ROKU', 'SPOT', 'PINS', 'SNAP', 'UBER', 'LYFT', 'DASH', 'ABNB', 'BKNG', 'EXPE', 'TRIP',
                // Healthcare Technology & Telemedicine
                'TDOC', 'VEEV', 'DXCM', 'ISRG', 'PODD', 'TMDX', 'OMCL', 'IRTC', 'ONEM', 'AMWL', 'HIMS', 'DOCS', 'ACCD', 'WELL',
                // Emerging Growth & Small-Cap Innovators
                'PTON', 'LMND', 'ROOT', 'MTCH', 'BMBL', 'YELP', 'W', 'FTCH', 'RH', 'CVNA', 'CARG', 'RDFN', 'ZILLOW', 'OPENDOOR',
                // International Growth & Emerging Markets
                'BABA', 'JD', 'PDD', 'BIDU', 'SE', 'MELI', 'GLOB', 'CPNG', 'GRAB', 'BEKE', 'TME', 'BILI', 'VIPS', 'TCOM'
            ];

            const candidates = [];

            try {
                // Analyze fewer stocks concurrently for faster loading
                const selectedStocks = stockCandidates.slice(0, 8); // Reduced from 15 to 8 for faster loading
                console.log(`Analyzing ${selectedStocks.length} stocks concurrently...`);

                // Make concurrent API calls instead of sequential
                const promises = selectedStocks.map(async (symbol) => {
                    try {
                        console.log(`Fetching prediction for ${symbol}...`);
                        const response = await fetch('/api/predict', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                symbol: symbol,
                                timeframe: 'auto'
                            })
                        });

                        if (response.ok) {
                            const prediction = await response.json();
                            console.log(`Prediction for ${symbol}:`, prediction);
                            return { symbol, prediction };
                        }
                    } catch (error) {
                        console.error(`Error fetching ${symbol}:`, error);
                    }
                    return null;
                });

                // Wait for all predictions to complete
                const results = await Promise.all(promises);

                // Process results
                for (const result of results) {
                    if (result && result.prediction) {
                        const { symbol, prediction } = result;

                        // Balanced filtering for quality growth opportunities
                        if (!prediction.error &&
                            prediction.expected_change_percent >= 6 && // Meaningful growth threshold
                            prediction.confidence >= 60 && // Reasonable confidence requirement
                            (prediction.prediction.includes('BUY') || prediction.prediction.includes('STRONG'))) { // Remove SPECULATIVE from main filter
                            const safetyScore = calculateSafetyScore(prediction);
                            const growthScore = calculateGrowthScore(prediction);
                            const hiddenGemScore = calculateHiddenGemScore(prediction);
                            const overallScore = (safetyScore * 0.25) + (growthScore * 0.55) + (hiddenGemScore * 0.2); // Balanced weighting

                            candidates.push({
                                symbol: prediction.symbol,
                                data: {
                                    name: prediction.company_name,
                                    price: prediction.current_price,
                                    sector: prediction.sector,
                                    marketCap: prediction.market_cap
                                },
                                analysis: {
                                    upside: prediction.expected_change_percent,
                                    confidence: prediction.confidence,
                                    prediction: prediction.prediction,
                                    timeframe: prediction.timeframe,
                                    safetyScore: safetyScore,
                                    growthScore: growthScore,
                                    hiddenGemScore: hiddenGemScore,
                                    overallScore: overallScore
                                },
                                reasoning: generateOpportunityReasoning(prediction)
                            });
                            console.log(`Added ${symbol} to candidates`);
                        } else {
                            console.log(`Skipped ${symbol}: error or negative change`);
                        }
                    }
                }

                console.log(`Total candidates found: ${candidates.length}`);

                // If we don't have enough candidates, expand search for growth opportunities
                if (candidates.length < 6) {
                    console.log('Not enough candidates, expanding search for growth opportunities...');
                    // Try more stocks with growth-focused criteria
                    for (let i = 15; i < Math.min(25, stockCandidates.length); i++) {
                        const symbol = stockCandidates[i];
                        try {
                            const response = await fetch('/api/predict', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ symbol: symbol, timeframe: 'auto' })
                            });

                            if (response.ok) {
                                const prediction = await response.json();
                                if (!prediction.error &&
                                    prediction.expected_change_percent >= 5 && // Maintain quality threshold
                                    prediction.confidence >= 55 && // Reasonable confidence for backup
                                    (prediction.prediction.includes('BUY') || prediction.prediction.includes('STRONG'))) { // Focus on quality BUY signals

                                    const safetyScore = calculateSafetyScore(prediction);
                                    const growthScore = calculateGrowthScore(prediction);
                                    const hiddenGemScore = calculateHiddenGemScore(prediction);
                                    const overallScore = (safetyScore * 0.25) + (growthScore * 0.55) + (hiddenGemScore * 0.2); // Balanced weighting

                                    candidates.push({
                                        symbol: prediction.symbol,
                                        data: {
                                            name: prediction.company_name,
                                            price: prediction.current_price,
                                            sector: prediction.sector,
                                            marketCap: prediction.market_cap
                                        },
                                        analysis: {
                                            upside: prediction.expected_change_percent,
                                            confidence: prediction.confidence,
                                            prediction: prediction.prediction,
                                            timeframe: prediction.timeframe,
                                            safetyScore: safetyScore,
                                            growthScore: growthScore,
                                            hiddenGemScore: hiddenGemScore,
                                            overallScore: overallScore
                                        },
                                        reasoning: generateOpportunityReasoning(prediction)
                                    });
                                }
                            }
                        } catch (error) {
                            console.error(`Error with backup symbol ${symbol}:`, error);
                        }

                        // Add delay between backup requests
                        if (i < Math.min(24, stockCandidates.length - 1)) {
                            await new Promise(resolve => setTimeout(resolve, 150)); // Faster delay for more stocks
                        }
                    }
                }

                // Sort by overall score (safety + growth) and take top 6
                candidates.sort((a, b) => b.analysis.overallScore - a.analysis.overallScore);
                const topOpportunities = candidates.slice(0, 6);

                console.log('Final top opportunities:', topOpportunities);

                // If still no opportunities, show hidden gem fallback recommendations
                if (topOpportunities.length === 0) {
                    console.log('No opportunities found, showing hidden gem fallback recommendations...');
                    const fallbackOpportunities = [
                        {
                            symbol: 'PLTR',
                            data: { name: 'Palantir Technologies', price: 28.50, sector: 'Technology' },
                            analysis: { upside: 18.5, confidence: 68, prediction: 'SPECULATIVE BUY', timeframe: '3-6 months' },
                            reasoning: 'AI data analytics pioneer with government contracts'
                        },
                        {
                            symbol: 'SOFI',
                            data: { name: 'SoFi Technologies', price: 12.25, sector: 'Financial Services' },
                            analysis: { upside: 22.3, confidence: 65, prediction: 'BUY', timeframe: '6-12 months' },
                            reasoning: 'Digital banking disruptor with strong user growth'
                        },
                        {
                            symbol: 'ENPH',
                            data: { name: 'Enphase Energy', price: 145.80, sector: 'Clean Energy' },
                            analysis: { upside: 15.7, confidence: 72, prediction: 'BUY', timeframe: '3-9 months' },
                            reasoning: 'Solar microinverter leader in growing renewable market'
                        },
                        {
                            symbol: 'NVDA',
                            data: { name: 'NVIDIA Corporation', price: 875.50, sector: 'Technology' },
                            analysis: { upside: 28.8, confidence: 78, prediction: 'STRONG BUY', timeframe: '6-12 months' },
                            reasoning: 'AI chip leader driving the artificial intelligence revolution'
                        },
                        {
                            symbol: 'RKLB',
                            data: { name: 'Rocket Lab USA', price: 8.90, sector: 'Space Technology' },
                            analysis: { upside: 42.4, confidence: 63, prediction: 'SPECULATIVE BUY', timeframe: '6-12 months' },
                            reasoning: 'Small satellite launch leader in rapidly growing space economy'
                        },
                        {
                            symbol: 'IONQ',
                            data: { name: 'IonQ Inc.', price: 12.40, sector: 'Quantum Computing' },
                            analysis: { upside: 35.7, confidence: 58, prediction: 'SPECULATIVE BUY', timeframe: '6-12 months' },
                            reasoning: 'Quantum computing pioneer with breakthrough technology'
                        },
                        {
                            symbol: 'CRSP',
                            data: { name: 'CRISPR Therapeutics', price: 68.90, sector: 'Biotech' },
                            analysis: { upside: 32.2, confidence: 62, prediction: 'SPECULATIVE BUY', timeframe: '6-12 months' },
                            reasoning: 'Gene editing technology leader with breakthrough therapies'
                        }
                    ];
                    displayFeaturedOpportunities(fallbackOpportunities);
                } else {
                    displayFeaturedOpportunities(topOpportunities);
                }
            } catch (error) {
                console.error('Error generating featured opportunities:', error);
                // Show high-growth fallback even on error
                const fallbackOpportunities = [
                    {
                        symbol: 'NVDA',
                        data: { name: 'NVIDIA Corporation', price: 875.50, sector: 'Technology' },
                        analysis: { upside: 28.8, confidence: 78, prediction: 'STRONG BUY', timeframe: '6-12 months' },
                        reasoning: 'AI chip leader driving the artificial intelligence revolution'
                    },
                    {
                        symbol: 'PLTR',
                        data: { name: 'Palantir Technologies', price: 28.50, sector: 'Technology' },
                        analysis: { upside: 32.5, confidence: 68, prediction: 'SPECULATIVE BUY', timeframe: '6-12 months' },
                        reasoning: 'AI data analytics pioneer expanding into commercial markets'
                    },
                    {
                        symbol: 'RKLB',
                        data: { name: 'Rocket Lab USA', price: 8.90, sector: 'Space Technology' },
                        analysis: { upside: 42.4, confidence: 63, prediction: 'SPECULATIVE BUY', timeframe: '6-12 months' },
                        reasoning: 'Small satellite launch leader in rapidly growing space economy'
                    }
                ];
                displayFeaturedOpportunities(fallbackOpportunities);
            }
        }

        function calculateSafetyScore(prediction) {
            let score = 0;

            // Confidence level (moderate weight for confidence)
            score += prediction.confidence * 0.3; // Reduced weight to allow more speculative opportunities

            // Market cap safety (less restrictive for growth opportunities)
            if (prediction.market_cap > 100000000000) score += 15; // >$100B (large cap) - reduced bonus
            else if (prediction.market_cap > 10000000000) score += 12; // >$10B (mid cap)
            else if (prediction.market_cap > 2000000000) score += 10; // >$2B (small cap)
            else if (prediction.market_cap > 500000000) score += 8; // >$500M (micro cap)
            else if (prediction.market_cap > 100000000) score += 5; // >$100M (small micro cap)
            else score += 0; // No penalty for very small caps in growth context

            // Sector safety (more inclusive of growth sectors)
            const safeSectors = ['Technology', 'Healthcare', 'Consumer Staples', 'Utilities', 'Financials', 'Communication Services', 'Clean Energy'];
            if (safeSectors.includes(prediction.sector)) score += 12; // Reduced bonus

            // Growth sectors get safety points regardless of size (encouraging innovation)
            const growthSectors = ['Technology', 'Healthcare', 'Cybersecurity', 'Biotech', 'Clean Energy', 'Fintech'];
            if (growthSectors.includes(prediction.sector)) score += 8;

            // Innovation sectors get safety bonus (these are the future)
            const innovationSectors = ['Artificial Intelligence', 'Quantum Computing', 'Space Technology', 'Gene Therapy'];
            if (innovationSectors.some(sector => prediction.sector?.includes(sector) || prediction.company_name?.includes(sector))) score += 10;

            // Less harsh penalty for penny stocks in growth context
            if (!prediction.is_penny_stock) score += 10; // Reduced bonus
            else score -= 5; // Much smaller penalty

            // Prediction strength adds to safety (strong predictions are safer bets)
            if (prediction.prediction.includes('STRONG BUY')) score += 8;
            else if (prediction.prediction.includes('BUY')) score += 5;
            else if (prediction.prediction.includes('SPECULATIVE')) score += 3; // Even speculative gets some safety points

            return Math.max(Math.min(score, 100), 0);
        }

        function calculateGrowthScore(prediction) {
            let score = 0;

            // Expected change (main factor with exponential scaling for high growth)
            const changePercent = prediction.expected_change_percent;
            if (changePercent > 40) score += 90; // Exceptional growth potential
            else if (changePercent > 30) score += 80; // Very high growth
            else if (changePercent > 25) score += 70; // High growth
            else if (changePercent > 20) score += 60; // Good growth
            else if (changePercent > 15) score += 50; // Moderate growth
            else if (changePercent > 10) score += 35; // Low-moderate growth
            else if (changePercent > 5) score += 20; // Low growth
            else score += changePercent * 2; // Linear for smaller gains

            // Emerging high-growth sectors get major bonus
            const emergingGrowthSectors = ['Technology', 'Artificial Intelligence', 'Quantum Computing', 'Space Technology', 'Cybersecurity', 'Biotech', 'Clean Energy'];
            if (emergingGrowthSectors.some(sector => prediction.sector?.includes(sector) || prediction.company_name?.includes(sector))) score += 35;

            // Traditional high-growth sectors get good bonus
            const highGrowthSectors = ['Healthcare', 'Communication Services', 'Consumer Discretionary', 'Fintech'];
            if (highGrowthSectors.includes(prediction.sector)) score += 25;

            // Innovation/disruptive company indicators (check company name for keywords)
            const innovationKeywords = ['AI', 'Cloud', 'Data', 'Cyber', 'Gene', 'Electric', 'Solar', 'Quantum', 'Space', 'Robotics'];
            if (innovationKeywords.some(keyword => prediction.company_name?.includes(keyword))) score += 20;

            // Timeframe bonus (reward confident longer-term predictions for growth)
            if (prediction.timeframe === '6-12 months') score += 30; // Long-term growth confidence
            else if (prediction.timeframe === '3-6 months') score += 25; // Medium-term confidence
            else if (prediction.timeframe === '2-3 months') score += 15;
            else if (prediction.timeframe === '1-2 months') score += 5;

            // Confidence bonus (balanced approach for growth opportunities)
            if (prediction.confidence > 75) score += 20; // High confidence in growth
            else if (prediction.confidence > 65) score += 15;
            else if (prediction.confidence > 55) score += 10; // Still reward moderate confidence for speculative growth
            else if (prediction.confidence > 45) score += 5; // Minimal reward for low confidence

            // Prediction strength bonus (favor aggressive growth predictions)
            if (prediction.prediction.includes('SPECULATIVE BUY')) score += 35; // Highest reward for speculative growth
            else if (prediction.prediction.includes('STRONG BUY')) score += 30;
            else if (prediction.prediction.includes('BUY')) score += 20;

            // Market cap bonus for growth potential (smaller companies often have higher growth potential)
            if (prediction.market_cap && prediction.market_cap < 1000000000) score += 15; // Under $1B
            else if (prediction.market_cap && prediction.market_cap < 5000000000) score += 10; // Under $5B
            else if (prediction.market_cap && prediction.market_cap < 20000000000) score += 5; // Under $20B

            return Math.max(0, Math.min(120, score)); // Allow scores above 100 for exceptional growth opportunities
        }

        function calculateHiddenGemScore(prediction) {
            let score = 0;

            // Favor smaller market caps with exponential scaling (hidden gems are typically smaller companies)
            if (prediction.market_cap < 500000000) score += 50; // Micro cap bonus (under $500M)
            else if (prediction.market_cap < 2000000000) score += 45; // Small cap bonus (under $2B)
            else if (prediction.market_cap < 10000000000) score += 35; // Mid cap bonus (under $10B)
            else if (prediction.market_cap < 50000000000) score += 20; // Large cap but not mega (under $50B)
            else if (prediction.market_cap < 100000000000) score += 5; // Large cap (under $100B)
            else score -= 25; // Penalty for mega caps (not hidden gems)

            // Favor emerging and disruptive sectors
            const emergingGemSectors = ['Artificial Intelligence', 'Quantum Computing', 'Space Technology', 'Gene Therapy', 'Robotics', 'Autonomous Vehicles'];
            if (emergingGemSectors.some(sector => prediction.sector?.includes(sector) || prediction.company_name?.includes(sector))) score += 35;

            // Traditional hidden gem sectors
            const hiddenGemSectors = ['Clean Energy', 'Cybersecurity', 'Fintech', 'Gaming', 'E-commerce', 'Biotech', 'SaaS'];
            if (hiddenGemSectors.includes(prediction.sector)) score += 25;

            // Reward speculative and high-risk opportunities
            if (prediction.prediction.includes('SPECULATIVE')) score += 40; // Higher reward for speculative
            else if (prediction.prediction.includes('STRONG BUY')) score += 25;
            else if (prediction.prediction.includes('BUY')) score += 20;

            // Favor moderate to high confidence for hidden gems (balance between opportunity and risk)
            if (prediction.confidence >= 60 && prediction.confidence <= 80) score += 25; // Sweet spot for hidden gems
            else if (prediction.confidence >= 50 && prediction.confidence < 60) score += 20; // Good for speculative gems
            else if (prediction.confidence > 80) score += 10; // Still good but less "hidden"
            else if (prediction.confidence < 50) score -= 10; // Too risky even for hidden gems

            // Reward significant growth potential (hidden gems should have major upside)
            if (prediction.expected_change_percent > 30) score += 35; // Exceptional upside
            else if (prediction.expected_change_percent > 25) score += 30; // Very high upside
            else if (prediction.expected_change_percent > 20) score += 25; // High upside
            else if (prediction.expected_change_percent > 15) score += 20; // Good upside
            else if (prediction.expected_change_percent > 10) score += 15; // Moderate upside
            else if (prediction.expected_change_percent < 8) score -= 20; // Low upside not exciting for hidden gems

            // Favor longer timeframes (hidden gems take time to be recognized and develop)
            if (prediction.timeframe === '6-12 months') score += 25; // Best for hidden gem development
            else if (prediction.timeframe === '3-6 months') score += 20; // Good timeframe
            else if (prediction.timeframe === '2-3 months') score += 10; // Acceptable
            else score += 5; // Short-term less ideal for hidden gems

            // Bonus for companies with innovation indicators in name
            const innovationIndicators = ['Tech', 'AI', 'Data', 'Cloud', 'Cyber', 'Bio', 'Gene', 'Solar', 'Electric', 'Quantum', 'Space'];
            if (innovationIndicators.some(indicator => prediction.company_name?.includes(indicator))) score += 15;

            return Math.max(0, Math.min(120, score)); // Allow higher scores for exceptional hidden gems
        }

        function generateOpportunityReasoning(prediction) {
            const reasons = [];

            // Focus on market context and growth drivers
            if (prediction.market_cap < 2000000000) {
                reasons.push("Emerging company with significant growth runway");
            } else if (prediction.market_cap < 10000000000) {
                reasons.push("Mid-cap positioned for market expansion");
            } else if (prediction.confidence < 75) {
                reasons.push("Market hasn't fully recognized value potential");
            }

            if (prediction.expected_change_percent > 20) {
                reasons.push("Strong catalysts driving substantial upside");
            } else if (prediction.expected_change_percent > 15) {
                reasons.push("Multiple growth drivers align favorably");
            } else if (prediction.expected_change_percent > 10) {
                reasons.push("Solid fundamentals support steady growth");
            }

            // Sector-specific world event reasoning
            if (prediction.sector === 'Technology') {
                reasons.push("AI revolution and digital transformation beneficiary");
            } else if (prediction.sector === 'Healthcare' || prediction.sector === 'Biotech') {
                reasons.push("Aging demographics and medical innovation trends");
            } else if (prediction.sector === 'Clean Energy') {
                reasons.push("Energy transition and climate policy support");
            } else if (prediction.sector === 'Fintech' || prediction.sector === 'Financial Services') {
                reasons.push("Interest rate environment and fintech disruption");
            } else if (prediction.sector === 'Gaming' || prediction.sector === 'E-commerce') {
                reasons.push("Digital economy and consumer behavior shifts");
            }

            if (prediction.prediction.includes('SPECULATIVE')) {
                reasons.push("Emerging opportunity with transformative potential");
            } else if (prediction.prediction.includes('BUY')) {
                reasons.push("Fundamentals align with favorable market conditions");
            }

            return reasons.length > 0 ? reasons.slice(0, 2).join(" • ") : "Market conditions support growth opportunity";
        }

        function generateSimpleReasoning(symbol, data) {
            if (data.pe < 20) return "Attractive valuation amid current market conditions";
            if (data.sector === 'Technology') return "Positioned to benefit from AI revolution and digital transformation";
            if (data.sector === 'Energy') return "Energy transition and geopolitical factors create opportunities";
            if (data.sector === 'Financial') return "Interest rate environment and digital banking trends";
            if (data.sector === 'Healthcare') return "Aging demographics and healthcare innovation drive growth";
            if (data.sector === 'Consumer Discretionary') return "Consumer spending patterns and economic recovery";
            if (data.sector === 'Industrials') return "Infrastructure spending and supply chain reshoring trends";
            return "Market conditions and company fundamentals support growth potential";
        }

        function displayFeaturedOpportunities(featured) {
            const grid = document.getElementById('featuredGrid');

            if (!grid) {
                console.error('Featured grid element not found');
                return;
            }

            if (featured.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; color: #888; padding: 40px;">
                        <i class="fas fa-chart-line" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>No opportunities found at this time. Please try again later.</p>
                    </div>
                `;
                return;
            }

            console.log('Displaying featured opportunities:', featured);

            grid.innerHTML = featured.map((item, index) => {
                try {
                    const changeClass = item.analysis.upside > 0 ? 'positive' : 'negative';
                    const changeSign = item.analysis.upside > 0 ? '+' : '';

                    return `
                        <div class="featured-card animate-fade-in" onclick="analyzeFeatured('${item.symbol}')" style="animation-delay: ${index * 0.1}s">
                            <div class="featured-header">
                                <div class="featured-symbol">${item.symbol}</div>
                                <div class="featured-upside ${changeClass}">${changeSign}${item.analysis.upside.toFixed(1)}%</div>
                            </div>
                            <div class="featured-company">${item.data.name || item.symbol}</div>
                            <div class="featured-price">$${(item.data.price || 0).toFixed(2)}</div>
                            <div class="featured-prediction">${item.analysis.prediction || 'N/A'}</div>
                            <div class="featured-timeframe">${item.analysis.timeframe || 'N/A'}</div>
                            <div class="featured-reason">${item.reasoning || 'AI-identified opportunity'}</div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error rendering featured opportunity:', item, error);
                    return '';
                }
            }).join('');
        }

        function analyzeFeatured(symbol) {
            switchTab('analysis');
            setTimeout(() => {
                document.getElementById('stockSymbol').value = symbol;
                predictStock();
            }, 100);
        }

        // AI Recommendation System - Realistic Valuation
        function calculateIntrinsicValue(symbol, stockData) {
            // Use the same prediction logic as the main analysis for consistency
            const prediction = generatePrediction(symbol, stockData);

            return {
                intrinsicValue: parseFloat(prediction.target_price),
                upside: parseFloat(prediction.expected_change_percent),
                confidence: parseFloat(prediction.confidence),
                risk_factors: prediction.risk_factors || []
            };
        }





        function generateAIReasoning(data) {
            // Use the enhanced reasoning provided by the backend if available
            if (data.enhanced_reasoning && data.enhanced_reasoning.length > 0) {
                let reasoningHtml = '';
                data.enhanced_reasoning.forEach(point => {
                    reasoningHtml += `
                        <div class="reasoning-item">
                            <div class="reasoning-icon">${point.icon}</div>
                            <div class="reasoning-text">
                                <strong>${point.title}:</strong> ${point.text}
                            </div>
                        </div>
                    `;
                });
                return reasoningHtml;
            }

            // Fallback to simple reasoning if enhanced not available
            if (data.reasoning) {
                return `
                    <div class="reasoning-item">
                        <div class="reasoning-icon">🤖</div>
                        <div class="reasoning-text">
                            <strong>AI Analysis:</strong> ${data.reasoning}
                        </div>
                    </div>
                `;
            }

            // Fallback to client-side reasoning generation
            const symbol = data.symbol;
            const sector = data.sector || 'Unknown';
            const prediction = data.prediction;
            const changePercent = data.expected_change_percent;

            // Generate reasoning based on stock characteristics and market conditions
            const reasoningFactors = [];

            // Sector-specific reasoning
            if (sector === 'Technology') {
                if (changePercent > 0) {
                    reasoningFactors.push({
                        title: "🚀 AI Revolution Momentum",
                        content: "Technology sector is experiencing unprecedented growth driven by artificial intelligence adoption. Companies in this space are seeing increased demand for AI infrastructure, cloud computing, and automation solutions."
                    });
                    reasoningFactors.push({
                        title: "💼 Enterprise Digital Transformation",
                        content: "Businesses are accelerating digital transformation initiatives, creating sustained demand for technology solutions. This trend is expected to continue as companies modernize their operations."
                    });
                } else {
                    reasoningFactors.push({
                        title: "⚠️ Tech Sector Headwinds",
                        content: "Technology stocks face pressure from rising interest rates, regulatory concerns, and market saturation in some segments. Investors are becoming more selective about tech investments."
                    });
                }
            } else if (sector === 'Energy') {
                if (changePercent > 0) {
                    reasoningFactors.push({
                        title: "⚡ Energy Transition Opportunities",
                        content: "The global shift toward renewable energy and energy independence is creating new opportunities. Traditional energy companies are adapting and investing in cleaner technologies."
                    });
                    reasoningFactors.push({
                        title: "🌍 Geopolitical Energy Dynamics",
                        content: "Global energy security concerns and supply chain diversification are benefiting domestic energy producers and companies with strategic reserves."
                    });
                }
            } else if (sector === 'Financial') {
                if (changePercent > 0) {
                    reasoningFactors.push({
                        title: "📈 Rising Interest Rate Environment",
                        content: "Higher interest rates typically benefit financial institutions through improved net interest margins. Banks and financial services companies are positioned to benefit from this trend."
                    });
                    reasoningFactors.push({
                        title: "🏦 Economic Resilience",
                        content: "Strong consumer spending and business investment are supporting loan demand and reducing credit risk concerns for financial institutions."
                    });
                }
            } else if (sector === 'Healthcare' || sector === 'Biotech') {
                if (changePercent > 0) {
                    reasoningFactors.push({
                        title: "🧬 Medical Innovation Pipeline",
                        content: "Breakthrough developments in biotechnology, personalized medicine, and AI-driven drug discovery are creating significant value opportunities in healthcare."
                    });
                    reasoningFactors.push({
                        title: "👥 Aging Demographics",
                        content: "Global demographic trends toward an aging population are driving sustained demand for healthcare services and innovative medical solutions."
                    });
                }
            } else if (sector === 'Automotive') {
                if (changePercent > 0) {
                    reasoningFactors.push({
                        title: "🔋 Electric Vehicle Revolution",
                        content: "The transition to electric vehicles is accelerating globally, driven by environmental regulations, technological advances, and changing consumer preferences."
                    });
                    reasoningFactors.push({
                        title: "🤖 Autonomous Driving Progress",
                        content: "Advances in autonomous driving technology and AI are creating new revenue streams and market opportunities for automotive companies."
                    });
                }
            }

            // Market condition reasoning
            if (Math.abs(changePercent) > 10) {
                if (changePercent > 0) {
                    reasoningFactors.push({
                        title: "📊 Technical Momentum",
                        content: "Strong technical indicators suggest continued upward momentum. Market sentiment and trading patterns indicate institutional confidence in the stock's direction."
                    });
                } else {
                    reasoningFactors.push({
                        title: "⚡ Market Correction Signals",
                        content: "Technical analysis indicates potential downward pressure. Market conditions and sentiment suggest a period of consolidation or correction may be ahead."
                    });
                }
            }

            // Volatility reasoning
            const volatility = data.technical_indicators?.volatility || 0;
            if (volatility > 40) {
                reasoningFactors.push({
                    title: "🌊 High Volatility Environment",
                    content: "Current market conditions show elevated volatility, which can create both opportunities and risks. This environment often rewards careful timing and risk management."
                });
            }

            // Always add fundamental analysis factor
            const pe = stockData?.pe || 25;
            if (pe < 20) {
                reasoningFactors.push({
                    title: "💰 Attractive Valuation",
                    content: `Trading at a P/E ratio of ${pe}, this stock appears undervalued compared to market averages. This creates potential for price appreciation as the market recognizes its true value.`
                });
            } else if (pe > 35) {
                reasoningFactors.push({
                    title: "⚠️ Premium Valuation",
                    content: `With a P/E ratio of ${pe}, the stock trades at a premium to market averages. This suggests high growth expectations are already priced in.`
                });
            }

            // Always add market sentiment factor
            if (changePercent > 5) {
                reasoningFactors.push({
                    title: "📈 Positive Market Sentiment",
                    content: "Current market sentiment and institutional investor positioning suggest continued confidence in the stock's prospects. Recent trading patterns indicate accumulation by informed investors."
                });
            } else if (changePercent < -5) {
                reasoningFactors.push({
                    title: "📉 Market Concerns",
                    content: "Market sentiment reflects concerns about near-term challenges. Institutional positioning and trading patterns suggest a cautious approach from investors."
                });
            }

            // Ensure we always have at least 2 factors
            if (reasoningFactors.length === 0) {
                reasoningFactors.push({
                    title: "📊 Market Analysis",
                    content: "Our AI model has analyzed current market conditions, economic trends, and sector dynamics to assess the stock's potential in the current environment."
                });
                reasoningFactors.push({
                    title: "🎯 Market Positioning",
                    content: "Based on the company's market position, competitive advantages, and current business fundamentals, our model has assessed the stock's potential for the coming months."
                });
            }

            // Generate summary
            let summary = "";
            if (prediction.includes('BUY')) {
                summary = `Our AI model recommends ${prediction} based on ${reasoningFactors.length} key factors including favorable market conditions and sector trends. Current economic environment and company fundamentals support a ${Math.abs(changePercent)}% potential upside.`;
            } else if (prediction.includes('SELL')) {
                summary = `Our AI model recommends ${prediction} due to ${reasoningFactors.length} concerning factors. Economic headwinds and market conditions suggest potential downside risk of ${Math.abs(changePercent)}%.`;
            } else {
                summary = `Our AI model recommends ${prediction} as current market conditions present mixed signals. While some economic factors are positive, others suggest caution, leading to a balanced outlook.`;
            }

            // Build HTML
            let html = '';
            reasoningFactors.forEach(factor => {
                html += `
                    <div class="reasoning-factor">
                        <h4>${factor.title}</h4>
                        <p>${factor.content}</p>
                    </div>
                `;
            });

            html += `
                <div class="reasoning-summary">
                    <h4>🎯 AI Analysis Summary</h4>
                    <p>${summary}</p>
                </div>
            `;

            return html;
        }

        // Initialize page state
        if (!currentUser) {
            showLandingPage();
        }
    </script>
</body>
</html>
